<!doctype html>
<html lang="ms" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMANIP - Sistem Tempahan Bilik</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slot-booked {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }
        .slot-available {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .slot-hover:hover {
            transform: scale(1.02);
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .bg-custom {
            background: var(--custom-bg, linear-gradient(135deg, #f0fdf4, #dcfce7));
        }
        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 40;
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-custom min-h-full"><!-- Real-time Sync Status -->
  <div id="sync-status" class="fixed top-4 left-4 z-50 no-print">
   <div class="bg-white/90 backdrop-blur-sm rounded-lg shadow-lg p-3"><!-- Main Status -->
    <div class="flex items-center gap-2">
     <div id="sync-indicator" class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div><span id="sync-text" class="text-sm font-medium text-gray-700">ONLINE</span> <span id="user-count" class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">1 pengguna</span>
    </div>
   </div>
  </div><!-- Background Customizer (Admin Only) -->
  <div id="bg-customizer" class="fixed top-4 right-4 z-50 no-print hidden"><button onclick="toggleBgCustomizer()" class="bg-gray-800 text-white p-2 rounded-full shadow-lg hover:bg-gray-700 transition-colors"> ğŸ¨ </button>
   <div id="bg-options" class="hidden absolute top-12 right-0 bg-white rounded-lg shadow-xl p-4 w-64">
    <h4 class="font-bold mb-3">Tukar Latar Belakang</h4>
    <div class="grid grid-cols-2 gap-2"><button onclick="changeBg('linear-gradient(135deg, #f0fdf4, #dcfce7)')" class="h-8 rounded" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7)"></button> <button onclick="changeBg('linear-gradient(135deg, #fef3c7, #fde68a)')" class="h-8 rounded" style="background: linear-gradient(135deg, #fef3c7, #fde68a)"></button> <button onclick="changeBg('linear-gradient(135deg, #dbeafe, #bfdbfe)')" class="h-8 rounded" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe)"></button> <button onclick="changeBg('linear-gradient(135deg, #f3e8ff, #e9d5ff)')" class="h-8 rounded" style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff)"></button> <button onclick="changeBg('linear-gradient(135deg, #fce7f3, #fbcfe8)')" class="h-8 rounded" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8)"></button> <button onclick="changeBg('linear-gradient(135deg, #ffffff, #f9fafb)')" class="h-8 rounded" style="background: linear-gradient(135deg, #ffffff, #f9fafb)"></button>
    </div>
   </div>
  </div>
  <div class="container mx-auto px-4 py-6"><!-- Header -->
   <header class="text-center mb-8">
    <p class="text-green-600 text-lg"><strong>Sistem Tempahan Bilik Digital</strong></p>
   </header><!-- Navigation -->
   <nav class="flex flex-wrap justify-center gap-4 mb-8 no-print"><button onclick="showPage('home')" class="nav-btn bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"> ğŸ  Utama </button> <button onclick="showPage('booking')" class="nav-btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"> ğŸ“ Tempah Bilik </button> <button onclick="showPage('schedule')" class="nav-btn bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"> ğŸ“… Lihat Jadual Tempahan </button> <button onclick="showPage('admin')" class="nav-btn bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"> âš™ï¸ Pentadbir </button>
   </nav><!-- Home Page -->
   <div id="home-page" class="page fade-in">
    <div class="max-w-4xl mx-auto">
     <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-8 text-center"><!-- Admin Edit Button -->
      <div id="admin-edit-home" class="hidden absolute top-4 right-4 z-10"><button onclick="toggleHomeEditor()" class="bg-orange-600 hover:bg-orange-700 text-white p-2 rounded-full shadow-lg transition-colors"> âœï¸ </button>
      </div><!-- Logo Section -->
      <div class="mb-6"><img id="school-logo" src="" alt="" class="hidden mx-auto mb-4 max-h-24 w-auto rounded-lg shadow-md">
       <div id="default-icon" class="text-6xl mb-6">
        ğŸ’»
       </div>
      </div><!-- Editable Content -->
      <h2 id="homepage-title" class="text-3xl font-bold text-gray-800 mb-4">Selamat Datang ke SMANIP</h2>
      <p id="homepage-description" class="text-gray-600 text-lg mb-8">Sistem tempahan bilik digital yang mudah dan cekap untuk semua guru dan pelajar.</p>
      <div class="grid md:grid-cols-3 gap-6">
       <div onclick="showPage('booking')" class="bg-green-50/90 backdrop-blur-sm p-6 rounded-lg border-2 border-green-200 hover:shadow-lg transition-shadow cursor-pointer transform hover:scale-105">
        <div class="text-3xl mb-3">
         ğŸ“
        </div>
        <h3 class="font-bold text-green-800 mb-2">Tempah Bilik</h3>
        <p class="text-green-600 text-sm">Buat tempahan bilik dengan mudah mengikut jadual waktu persekolahan</p>
       </div>
       <div onclick="showPage('schedule')" class="bg-blue-50/90 backdrop-blur-sm p-6 rounded-lg border-2 border-blue-200 hover:shadow-lg transition-shadow cursor-pointer transform hover:scale-105">
        <div class="text-3xl mb-3">
         ğŸ“…
        </div>
        <h3 class="font-bold text-blue-800 mb-2">Lihat Jadual</h3>
        <p class="text-blue-600 text-sm">Semak jadual tempahan mingguan dan ketersediaan bilik</p>
       </div>
       <div onclick="showPage('admin')" class="bg-purple-50/90 backdrop-blur-sm p-6 rounded-lg border-2 border-purple-200 hover:shadow-lg transition-shadow cursor-pointer transform hover:scale-105">
        <div class="text-3xl mb-3">
         âš™ï¸
        </div>
        <h3 class="font-bold text-purple-800 mb-2">Pentadbiran</h3>
        <p class="text-purple-600 text-sm">Urus dan pantau semua tempahan bilik digital</p>
       </div>
      </div><!-- Quick Stats -->
      <div class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4">
       <div onclick="showPage('admin')" class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg cursor-pointer hover:shadow-lg transform hover:scale-105 transition-all">
        <div class="text-2xl font-bold" id="total-bookings">
         0
        </div>
        <div class="text-sm">
         Jumlah Tempahan
        </div>
       </div>
       <div onclick="showPage('schedule')" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg cursor-pointer hover:shadow-lg transform hover:scale-105 transition-all">
        <div class="text-2xl font-bold" id="today-bookings">
         0
        </div>
        <div class="text-sm">
         Tempahan Hari Ini
        </div>
       </div>
       <div onclick="showPage('booking')" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg cursor-pointer hover:shadow-lg transform hover:scale-105 transition-all">
        <div class="text-2xl font-bold" id="available-slots">
         30
        </div>
        <div class="text-sm">
         Slot Tersedia
        </div>
       </div>
       <div onclick="showUsageDetails()" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-lg cursor-pointer hover:shadow-lg transform hover:scale-105 transition-all">
        <div class="text-2xl font-bold" id="usage-rate">
         0%
        </div>
        <div class="text-sm">
         Kadar Penggunaan
        </div>
       </div>
      </div>
     </div>
    </div><!-- Homepage Editor Modal (Admin Only) -->
    <div id="home-editor-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
     <div class="bg-white rounded-xl p-8 max-w-2xl mx-4 w-full max-h-[90vh] overflow-y-auto">
      <h3 class="text-xl font-bold text-gray-800 mb-6">âœï¸ Edit Homepage</h3>
      <form id="home-editor-form" class="space-y-6">
       <div><label for="edit-title" class="block text-sm font-medium text-gray-700 mb-2">Tajuk Utama</label> <input type="text" id="edit-title" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
       </div>
       <div><label for="edit-description" class="block text-sm font-medium text-gray-700 mb-2">Penerangan</label> <textarea id="edit-description" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
       </div>
       <div><label for="logo-upload" class="block text-sm font-medium text-gray-700 mb-2">Logo Sekolah</label> <input type="file" id="logo-upload" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
        <p class="text-sm text-gray-500 mt-1">Format: JPG, PNG, GIF (Maksimum: 2MB)</p><button type="button" onclick="removeLogo()" class="mt-2 text-red-600 hover:text-red-800 text-sm">Buang Logo</button>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Latar Belakang Homepage</label>
        <div class="mb-4"><label for="bg-upload" class="block text-sm font-medium text-gray-700 mb-2">Muat Naik Gambar/GIF Latar Belakang</label> <input type="file" id="bg-upload" accept="image/*,.gif" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
         <p class="text-sm text-gray-500 mt-1">Format: JPG, PNG, GIF (Maksimum: 5MB)</p><button type="button" onclick="removeCustomBg()" class="mt-2 text-red-600 hover:text-red-800 text-sm">Buang Gambar Latar Belakang</button>
        </div><!-- Tema Menarik -->
        <div class="mb-4">
         <h4 class="text-sm font-medium text-gray-700 mb-3">ğŸ¨ Tema Menarik</h4>
         <div class="grid grid-cols-1 gap-3"><!-- Tema Hijau Segar -->
          <div class="border rounded-lg p-3 hover:shadow-md transition-shadow">
           <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #10b981, #34d399)"></div><span class="font-medium text-gray-800">ğŸŒ¿ Hijau Segar</span>
           </div>
           <div class="grid grid-cols-3 gap-1"><button type="button" onclick="setHomeBg('linear-gradient(135deg, #ecfdf5, #d1fae5)')" class="h-8 rounded border hover:border-green-500" style="background: linear-gradient(135deg, #ecfdf5, #d1fae5)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #10b981, #34d399)')" class="h-8 rounded border hover:border-green-500" style="background: linear-gradient(135deg, #10b981, #34d399)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #065f46, #047857)')" class="h-8 rounded border hover:border-green-500" style="background: linear-gradient(135deg, #065f46, #047857)"></button>
           </div>
          </div><!-- Tema Biru Laut -->
          <div class="border rounded-lg p-3 hover:shadow-md transition-shadow">
           <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #0ea5e9, #38bdf8)"></div><span class="font-medium text-gray-800">ğŸŒŠ Biru Laut</span>
           </div>
           <div class="grid grid-cols-3 gap-1"><button type="button" onclick="setHomeBg('linear-gradient(135deg, #f0f9ff, #e0f2fe)')" class="h-8 rounded border hover:border-blue-500" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #0ea5e9, #38bdf8)')" class="h-8 rounded border hover:border-blue-500" style="background: linear-gradient(135deg, #0ea5e9, #38bdf8)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #0c4a6e, #075985)')" class="h-8 rounded border hover:border-blue-500" style="background: linear-gradient(135deg, #0c4a6e, #075985)"></button>
           </div>
          </div><!-- Tema Ungu Mewah -->
          <div class="border rounded-lg p-3 hover:shadow-md transition-shadow">
           <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa)"></div><span class="font-medium text-gray-800">ğŸ’œ Ungu Mewah</span>
           </div>
           <div class="grid grid-cols-3 gap-1"><button type="button" onclick="setHomeBg('linear-gradient(135deg, #faf5ff, #f3e8ff)')" class="h-8 rounded border hover:border-purple-500" style="background: linear-gradient(135deg, #faf5ff, #f3e8ff)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #8b5cf6, #a78bfa)')" class="h-8 rounded border hover:border-purple-500" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #581c87, #6b21a8)')" class="h-8 rounded border hover:border-purple-500" style="background: linear-gradient(135deg, #581c87, #6b21a8)"></button>
           </div>
          </div><!-- Tema Oren Hangat -->
          <div class="border rounded-lg p-3 hover:shadow-md transition-shadow">
           <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #f97316, #fb923c)"></div><span class="font-medium text-gray-800">ğŸ”¥ Oren Hangat</span>
           </div>
           <div class="grid grid-cols-3 gap-1"><button type="button" onclick="setHomeBg('linear-gradient(135deg, #fff7ed, #fed7aa)')" class="h-8 rounded border hover:border-orange-500" style="background: linear-gradient(135deg, #fff7ed, #fed7aa)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #f97316, #fb923c)')" class="h-8 rounded border hover:border-orange-500" style="background: linear-gradient(135deg, #f97316, #fb923c)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #9a3412, #c2410c)')" class="h-8 rounded border hover:border-orange-500" style="background: linear-gradient(135deg, #9a3412, #c2410c)"></button>
           </div>
          </div><!-- Tema Merah Jambu Lembut -->
          <div class="border rounded-lg p-3 hover:shadow-md transition-shadow">
           <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #ec4899, #f472b6)"></div><span class="font-medium text-gray-800">ğŸŒ¸ Merah Jambu Lembut</span>
           </div>
           <div class="grid grid-cols-3 gap-1"><button type="button" onclick="setHomeBg('linear-gradient(135deg, #fdf2f8, #fce7f3)')" class="h-8 rounded border hover:border-pink-500" style="background: linear-gradient(135deg, #fdf2f8, #fce7f3)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #ec4899, #f472b6)')" class="h-8 rounded border hover:border-pink-500" style="background: linear-gradient(135deg, #ec4899, #f472b6)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #831843, #be185d)')" class="h-8 rounded border hover:border-pink-500" style="background: linear-gradient(135deg, #831843, #be185d)"></button>
           </div>
          </div><!-- Tema Islamik -->
          <div class="border rounded-lg p-3 hover:shadow-md transition-shadow">
           <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #059669, #10b981)"></div><span class="font-medium text-gray-800">ğŸ•Œ Tema Islamik - Hijau Masjid</span>
           </div>
           <div class="grid grid-cols-3 gap-1"><button type="button" onclick="setHomeBg('linear-gradient(135deg, #f0fdf4, #dcfce7)')" class="h-8 rounded border hover:border-green-600" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #059669, #10b981)')" class="h-8 rounded border hover:border-green-600" style="background: linear-gradient(135deg, #059669, #10b981)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #064e3b, #065f46)')" class="h-8 rounded border hover:border-green-600" style="background: linear-gradient(135deg, #064e3b, #065f46)"></button>
           </div>
          </div><!-- Tema Islamik Emas -->
          <div class="border rounded-lg p-3 hover:shadow-md transition-shadow">
           <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #d97706, #f59e0b)"></div><span class="font-medium text-gray-800">âœ¨ Tema Islamik - Emas Klasik</span>
           </div>
           <div class="grid grid-cols-3 gap-1"><button type="button" onclick="setHomeBg('linear-gradient(135deg, #fffbeb, #fef3c7)')" class="h-8 rounded border hover:border-yellow-600" style="background: linear-gradient(135deg, #fffbeb, #fef3c7)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #d97706, #f59e0b)')" class="h-8 rounded border hover:border-yellow-600" style="background: linear-gradient(135deg, #d97706, #f59e0b)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #92400e, #b45309)')" class="h-8 rounded border hover:border-yellow-600" style="background: linear-gradient(135deg, #92400e, #b45309)"></button>
           </div>
          </div><!-- Tema Islamik Biru Turki -->
          <div class="border rounded-lg p-3 hover:shadow-md transition-shadow">
           <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #0369a1, #0284c7)"></div><span class="font-medium text-gray-800">ğŸŒ™ Tema Islamik - Biru Turki</span>
           </div>
           <div class="grid grid-cols-3 gap-1"><button type="button" onclick="setHomeBg('linear-gradient(135deg, #f0f9ff, #e0f2fe)')" class="h-8 rounded border hover:border-blue-600" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #0369a1, #0284c7)')" class="h-8 rounded border hover:border-blue-600" style="background: linear-gradient(135deg, #0369a1, #0284c7)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #0c4a6e, #075985)')" class="h-8 rounded border hover:border-blue-600" style="background: linear-gradient(135deg, #0c4a6e, #075985)"></button>
           </div>
          </div><!-- Tema Islamik Maroon -->
          <div class="border rounded-lg p-3 hover:shadow-md transition-shadow">
           <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #991b1b, #dc2626)"></div><span class="font-medium text-gray-800">ğŸ›ï¸ Tema Islamik - Maroon Mewah</span>
           </div>
           <div class="grid grid-cols-3 gap-1"><button type="button" onclick="setHomeBg('linear-gradient(135deg, #fef2f2, #fecaca)')" class="h-8 rounded border hover:border-red-600" style="background: linear-gradient(135deg, #fef2f2, #fecaca)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #991b1b, #dc2626)')" class="h-8 rounded border hover:border-red-600" style="background: linear-gradient(135deg, #991b1b, #dc2626)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #7f1d1d, #991b1b)')" class="h-8 rounded border hover:border-red-600" style="background: linear-gradient(135deg, #7f1d1d, #991b1b)"></button>
           </div>
          </div><!-- Tema Islamik Putih Suci -->
          <div class="border rounded-lg p-3 hover:shadow-md transition-shadow">
           <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0)"></div><span class="font-medium text-gray-800">ğŸ¤ Tema Islamik - Putih Suci</span>
           </div>
           <div class="grid grid-cols-3 gap-1"><button type="button" onclick="setHomeBg('linear-gradient(135deg, #ffffff, #f8fafc)')" class="h-8 rounded border hover:border-gray-400" style="background: linear-gradient(135deg, #ffffff, #f8fafc)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #f8fafc, #e2e8f0)')" class="h-8 rounded border hover:border-gray-400" style="background: linear-gradient(135deg, #f8fafc, #e2e8f0)"></button> <button type="button" onclick="setHomeBg('linear-gradient(135deg, #e2e8f0, #cbd5e1)')" class="h-8 rounded border hover:border-gray-400" style="background: linear-gradient(135deg, #e2e8f0, #cbd5e1)"></button>
           </div>
          </div><!-- Template Corak Islamik -->
          <div class="border rounded-lg p-3 hover:shadow-md transition-shadow">
           <div class="flex items-center gap-3 mb-2">
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-600 to-yellow-500"></div><span class="font-medium text-gray-800">ğŸ¨ Template Corak Islamik</span>
           </div>
           <div class="grid grid-cols-2 gap-2"><button type="button" onclick="setIslamicPattern('geometric')" class="h-12 rounded border hover:border-green-500 bg-gradient-to-br from-green-50 to-green-100 flex items-center justify-center text-xs font-medium"> Corak Geometri </button> <button type="button" onclick="setIslamicPattern('arabesque')" class="h-12 rounded border hover:border-blue-500 bg-gradient-to-br from-blue-50 to-blue-100 flex items-center justify-center text-xs font-medium"> Corak Arabesque </button> <button type="button" onclick="setIslamicPattern('calligraphy')" class="h-12 rounded border hover:border-yellow-500 bg-gradient-to-br from-yellow-50 to-yellow-100 flex items-center justify-center text-xs font-medium"> Kaligrafi </button> <button type="button" onclick="setIslamicPattern('mosque')" class="h-12 rounded border hover:border-purple-500 bg-gradient-to-br from-purple-50 to-purple-100 flex items-center justify-center text-xs font-medium"> Siluet Masjid </button>
           </div>
          </div>
         </div>
        </div>
       </div>
       <div class="flex gap-4"><button type="submit" class="flex-1 bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"> Simpan Perubahan </button> <button type="button" onclick="closeHomeEditor()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"> Batal </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Booking Page -->
   <div id="booking-page" class="page hidden fade-in">
    <div class="max-w-2xl mx-auto">
     <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ğŸ“ Borang Tempahan Bilik</h2>
      <form id="booking-form" class="space-y-6">
       <div><label for="teacher-name" class="block text-sm font-medium text-gray-700 mb-2">Nama Guru *</label> <input type="text" id="teacher-name" name="teacherName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white/80">
       </div>
       <div><label for="class-name" class="block text-sm font-medium text-gray-700 mb-2">Matapelajaran / Kelas *</label> <input type="text" id="class-name" name="className" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white/80" placeholder="Contoh: Matematik 4 Sains 1, Sejarah 5 Akaun 2">
       </div>
       <div><label for="purpose" class="block text-sm font-medium text-gray-700 mb-2">Tujuan Penggunaan *</label> <textarea id="purpose" name="purpose" required rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white/80" placeholder="Contoh: Pembelajaran ICT, Projek multimedia, Ujian online"></textarea>
       </div>
       <div class="grid md:grid-cols-2 gap-4">
        <div><label for="day" class="block text-sm font-medium text-gray-700 mb-2">Hari *</label> <select id="day" name="day" required onchange="checkAvailability()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white/80"> <option value="">Pilih Hari</option> <option value="Isnin">Isnin</option> <option value="Selasa">Selasa</option> <option value="Rabu">Rabu</option> <option value="Khamis">Khamis</option> <option value="Jumaat">Jumaat</option> <option value="Sabtu">Sabtu</option> <option value="Ahad">Ahad</option> </select>
        </div>
        <div><label for="category" class="block text-sm font-medium text-gray-700 mb-2">Sesi (Kategori Pelajar) *</label> <select id="category" name="category" required onchange="updateTimeSlots()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white/80"> <option value="">Pilih Sesi</option> <option value="menengah-bawah">Menengah Bawah</option> <option value="menengah-atas">Menengah Atas</option> </select>
        </div>
       </div>
       <div><label for="time-slot" class="block text-sm font-medium text-gray-700 mb-2">Masa *</label> <select id="time-slot" name="timeSlot" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white/80"> <option value="">Pilih sesi terlebih dahulu</option> </select>
        <div id="availability-status" class="mt-2 text-sm"></div>
       </div>
       <div id="custom-time-section" class="hidden"><label for="custom-time" class="block text-sm font-medium text-gray-700 mb-2">Masa Lain-lain</label> <input type="text" id="custom-time" name="customTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white/80" placeholder="Contoh: 2:00-3:00 petang, 3:00-4:00 petang">
       </div>
       <div><label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email (Opsyenal)</label> <input type="email" id="email" name="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white/80" placeholder="Untuk notifikasi pengesahan">
       </div><button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg transition-colors transform hover:scale-105"> ğŸ“ Hantar Tempahan </button>
      </form>
     </div>
    </div>
   </div><!-- Schedule Page -->
   <div id="schedule-page" class="page hidden fade-in">
    <div class="max-w-7xl mx-auto">
     <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-8">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6">
       <h2 class="text-2xl font-bold text-gray-800 mb-4 md:mb-0">ğŸ“… Jadual Tempahan Mingguan</h2>
       <div class="flex gap-2"><button onclick="refreshSchedule()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"> ğŸ”„ Refresh </button> <button onclick="manualSync()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"> âš¡ Sync Manual </button> <button onclick="forceSync()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"> ğŸš€ Auto Sync </button>
       </div>
      </div>
      <div class="mb-4 flex flex-wrap gap-4 justify-center">
       <div class="flex items-center gap-2">
        <div class="w-4 h-4 slot-available rounded"></div><span class="text-sm font-medium">Kosong</span>
       </div>
       <div class="flex items-center gap-2">
        <div class="w-4 h-4 slot-booked rounded"></div><span class="text-sm font-medium">Ditempah</span>
       </div>
      </div>
      <div class="mb-4 text-center">
       <h3 class="text-lg font-semibold text-gray-700" id="week-dates">Minggu:</h3>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full border-collapse border border-gray-300 bg-white rounded-lg overflow-hidden">
        <thead>
         <tr class="bg-gradient-to-r from-gray-100 to-gray-200">
          <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-800 min-w-[100px]">Hari</th>
          <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-800 min-w-[120px]">7:00-8:00</th>
          <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-800 min-w-[120px]">8:00-9:00</th>
          <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-800 min-w-[120px]">9:00-10:00</th>
          <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-800 min-w-[120px]">10:30-11:30</th>
          <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-800 min-w-[120px]">11:30-12:30</th>
          <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-800 min-w-[120px]">12:30-1:30</th>
          <th id="custom-time-header" class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-800 min-w-[120px] hidden">2:00-6:00 Petang</th>
         </tr>
        </thead>
        <tbody id="schedule-table"><!-- Schedule will be populated by JavaScript -->
        </tbody>
       </table>
      </div><!-- Schedule Summary -->
      <div class="mt-6 grid grid-cols-2 md:grid-cols-7 gap-4" id="weekday-summary">
       <div class="bg-green-100 p-4 rounded-lg text-center">
        <div class="text-lg font-bold text-green-800" id="monday-count">
         0
        </div>
        <div class="text-sm text-green-600">
         Isnin
        </div>
       </div>
       <div class="bg-blue-100 p-4 rounded-lg text-center">
        <div class="text-lg font-bold text-blue-800" id="tuesday-count">
         0
        </div>
        <div class="text-sm text-blue-600">
         Selasa
        </div>
       </div>
       <div class="bg-purple-100 p-4 rounded-lg text-center">
        <div class="text-lg font-bold text-purple-800" id="wednesday-count">
         0
        </div>
        <div class="text-sm text-purple-600">
         Rabu
        </div>
       </div>
       <div class="bg-orange-100 p-4 rounded-lg text-center">
        <div class="text-lg font-bold text-orange-800" id="thursday-count">
         0
        </div>
        <div class="text-sm text-orange-600">
         Khamis
        </div>
       </div>
       <div class="bg-red-100 p-4 rounded-lg text-center">
        <div class="text-lg font-bold text-red-800" id="friday-count">
         0
        </div>
        <div class="text-sm text-red-600">
         Jumaat
        </div>
       </div>
       <div class="bg-indigo-100 p-4 rounded-lg text-center">
        <div class="text-lg font-bold text-indigo-800" id="saturday-count">
         0
        </div>
        <div class="text-sm text-indigo-600">
         Sabtu
        </div>
       </div>
       <div class="bg-pink-100 p-4 rounded-lg text-center">
        <div class="text-lg font-bold text-pink-800" id="sunday-count">
         0
        </div>
        <div class="text-sm text-pink-600">
         Ahad
        </div>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Admin Page -->
   <div id="admin-page" class="page hidden fade-in">
    <div class="max-w-7xl mx-auto"><!-- Admin Login -->
     <div id="admin-login" class="max-w-md mx-auto bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">ğŸ” Log Masuk Pentadbir</h2>
      <form id="login-form" class="space-y-4">
       <div><label for="admin-username" class="block text-sm font-medium text-gray-700 mb-2">Nama Pengguna</label> <input type="text" id="admin-username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white/80">
       </div>
       <div><label for="admin-password" class="block text-sm font-medium text-gray-700 mb-2">Kata Laluan</label> <input type="password" id="admin-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white/80">
       </div><button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg transition-colors"> Masuk </button>
      </form>
     </div><!-- Admin Panel -->
     <div id="admin-panel" class="hidden bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-8">
      <div class="flex flex-col md:flex-row justify-between items-center mb-6">
       <h2 class="text-2xl font-bold text-gray-800 mb-4 md:mb-0">âš™ï¸ Panel Pentadbir</h2><button onclick="logoutAdmin()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"> Keluar </button>
      </div><!-- Real-Time Cloud Database Status -->
      <div class="mb-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200">
       <h3 class="text-lg font-bold text-blue-800 mb-4">â˜ï¸ Status Cloud Database Real-Time</h3>
       <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white/80 p-4 rounded-lg text-center">
         <div id="cloud-status" class="text-2xl font-bold text-green-600">
          ONLINE
         </div>
         <div class="text-sm text-gray-600">
          Status Cloud
         </div>
        </div>
        <div class="bg-white/80 p-4 rounded-lg text-center">
         <div id="active-devices" class="text-2xl font-bold text-blue-600">
          1
         </div>
         <div class="text-sm text-gray-600">
          Peranti Aktif
         </div>
        </div>
        <div class="bg-white/80 p-4 rounded-lg text-center">
         <div id="last-sync-time" class="text-2xl font-bold text-purple-600">
          Baru
         </div>
         <div class="text-sm text-gray-600">
          Sync Terakhir
         </div>
        </div>
        <div class="bg-white/80 p-4 rounded-lg text-center">
         <div id="sync-count" class="text-2xl font-bold text-orange-600">
          0
         </div>
         <div class="text-sm text-gray-600">
          Sync Hari Ini
         </div>
        </div>
       </div>
      </div><!-- Booking Control -->
      <div class="mb-6 bg-gradient-to-r from-yellow-50 to-amber-50 rounded-xl p-6 border border-yellow-200">
       <h3 class="text-lg font-bold text-yellow-800 mb-4">ğŸ›ï¸ Kawalan Tempahan Bilik</h3>
       <div class="flex flex-col gap-4">
        <div class="flex items-center justify-between">
         <div>
          <div class="text-lg font-semibold text-gray-800 mb-1">
           Status Tempahan
          </div>
          <div class="text-sm text-gray-600">
           Buka atau tutup sistem tempahan bilik
          </div>
         </div>
         <div class="flex items-center gap-4"><span id="booking-status-text" class="text-lg font-bold text-green-600">DIBUKA</span> <button onclick="toggleBookingStatus()" id="booking-toggle-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"> ğŸ”“ Tutup Tempahan </button>
         </div>
        </div><!-- Admin Quick Booking -->
        <div class="border-t border-yellow-300 pt-4"><button onclick="showAdminQuickBooking()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors w-full md:w-auto"> â• Tambah Tempahan (Admin) </button>
         <p class="text-xs text-gray-600 mt-2">Isi tempahan dahulu sebelum buka sistem untuk pengguna</p>
        </div>
       </div>
      </div><!-- Google Sheet Integration Status -->
      <div class="mb-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 border border-green-200">
       <h3 class="text-lg font-bold text-green-800 mb-4">ğŸ“Š Status Google Sheet Real-Time</h3>
       <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white/80 p-4 rounded-lg text-center">
         <div id="google-sheet-status" class="text-2xl font-bold text-green-600">
          CONNECTING
         </div>
         <div class="text-sm text-gray-600">
          Status Google Sheet
         </div>
        </div>
        <div class="bg-white/80 p-4 rounded-lg text-center">
         <div id="google-sheet-records" class="text-2xl font-bold text-green-600">
          0
         </div>
         <div class="text-sm text-gray-600">
          Records di Sheet
         </div>
        </div>
        <div class="bg-white/80 p-4 rounded-lg text-center">
         <div id="google-sheet-sync-time" class="text-2xl font-bold text-blue-600">
          -
         </div>
         <div class="text-sm text-gray-600">
          Last Sheet Sync
         </div>
        </div>
        <div class="bg-white/80 p-4 rounded-lg text-center">
         <div id="google-sheet-devices" class="text-2xl font-bold text-orange-600">
          0
         </div>
         <div class="text-sm text-gray-600">
          Devices Connected
         </div>
        </div>
       </div><!-- Canva Sheet Actions -->
       <div class="mt-4 flex flex-wrap gap-2 justify-center"><button onclick="reconnectCanvaSheet()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"> ğŸ”„ Reconnect Sheet </button> <button onclick="forceCanvaSheetSync()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"> ğŸ“Š Force Sheet Sync </button> <button onclick="exportToCanvaSheet()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"> ğŸ“¤ Export to Sheet </button> <button onclick="importFromCanvaSheet()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors"> ğŸ“¥ Import from Sheet </button>
       </div><!-- Sheet URL Display -->
       <div class="mt-4 p-3 bg-white/60 rounded-lg">
        <div class="text-sm font-medium text-gray-700 mb-1">
         Canva Sheet ID:
        </div>
        <div class="text-xs text-gray-600 font-mono bg-gray-100 p-2 rounded break-all" id="canva-sheet-id">
         Loading...
        </div>
       </div>
      </div><!-- Active Devices Panel -->
      <div class="mb-6 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-6 border border-green-200">
       <h3 class="text-lg font-bold text-green-800 mb-4">ğŸ“± Peranti Aktif Real-Time</h3>
       <div id="active-devices-list" class="space-y-2"><!-- Active devices will be populated by JavaScript -->
       </div>
      </div>
      <div class="mb-6 flex flex-wrap gap-4 justify-center"><button onclick="exportData()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors"> ğŸ“Š Eksport CSV </button> <button onclick="clearAllBookings()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors"> ğŸ—‘ï¸ Padam Semua </button> <button onclick="sendEmailNotifications()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors"> ğŸ“§ Hantar Email </button> <button onclick="forceCloudSync()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors"> â˜ï¸ Auto Sync Cloud </button>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full border-collapse border border-gray-300 bg-white rounded-lg overflow-hidden">
        <thead>
         <tr class="bg-gradient-to-r from-gray-100 to-gray-200">
          <th class="border border-gray-300 px-4 py-3 text-left font-semibold">ID</th>
          <th class="border border-gray-300 px-4 py-3 text-left font-semibold">Nama Guru</th>
          <th class="border border-gray-300 px-4 py-3 text-left font-semibold">Matapelajaran/Kelas</th>
          <th class="border border-gray-300 px-4 py-3 text-left font-semibold">Hari</th>
          <th class="border border-gray-300 px-4 py-3 text-left font-semibold">Masa</th>
          <th class="border border-gray-300 px-4 py-3 text-left font-semibold">Tujuan</th>
          <th class="border border-gray-300 px-4 py-3 text-left font-semibold">Email</th>
          <th class="border border-gray-300 px-4 py-3 text-left font-semibold">Tarikh</th>
          <th class="border border-gray-300 px-4 py-3 text-center font-semibold">Tindakan</th>
         </tr>
        </thead>
        <tbody id="admin-table"><!-- Admin data will be populated by JavaScript -->
        </tbody>
       </table>
      </div>
     </div>
    </div>
   </div><!-- Success Modal -->
   <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center transform scale-95 transition-transform">
     <div class="text-6xl mb-4">
      âœ…
     </div>
     <h3 class="text-xl font-bold text-green-800 mb-4">Kemaskini Berjaya!</h3>
     <p id="success-message" class="text-gray-600 mb-6"></p><button onclick="closeModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors"> Tutup </button>
    </div>
   </div><!-- Error Modal -->
   <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center transform scale-95 transition-transform">
     <div class="text-6xl mb-4">
      âŒ
     </div>
     <h3 class="text-xl font-bold text-red-800 mb-4">RALAT</h3>
     <p id="error-message" class="text-gray-600 mb-6"></p><button onclick="closeModal()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors"> Tutup </button>
    </div>
   </div><!-- Booking Details Modal -->
   <div id="booking-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-md mx-4">
     <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“‹ Maklumat Tempahan</h3>
     <div id="booking-details" class="space-y-2 text-sm"></div><button onclick="closeBookingModal()" class="mt-4 bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors"> Tutup </button>
    </div>
   </div><!-- Admin Quick Booking Modal -->
   <div id="admin-booking-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto">
    <div class="bg-white rounded-xl p-8 max-w-2xl mx-4 my-8 w-full">
     <h3 class="text-xl font-bold text-gray-800 mb-6">â• Tambah Tempahan (Admin)</h3>
     <form id="admin-booking-form" class="space-y-6">
      <div><label for="admin-teacher-name" class="block text-sm font-medium text-gray-700 mb-2">Nama Guru *</label> <input type="text" id="admin-teacher-name" name="teacherName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
      </div>
      <div><label for="admin-class-name" class="block text-sm font-medium text-gray-700 mb-2">Matapelajaran / Kelas *</label> <input type="text" id="admin-class-name" name="className" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white" placeholder="Contoh: Matematik 4 Sains 1, Sejarah 5 Akaun 2">
      </div>
      <div><label for="admin-purpose" class="block text-sm font-medium text-gray-700 mb-2">Tujuan Penggunaan *</label> <textarea id="admin-purpose" name="purpose" required rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white" placeholder="Contoh: Pembelajaran ICT, Projek multimedia, Ujian online"></textarea>
      </div>
      <div class="grid md:grid-cols-2 gap-4">
       <div><label for="admin-day" class="block text-sm font-medium text-gray-700 mb-2">Hari *</label> <select id="admin-day" name="day" required onchange="checkAdminAvailability()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"> <option value="">Pilih Hari</option> <option value="Isnin">Isnin</option> <option value="Selasa">Selasa</option> <option value="Rabu">Rabu</option> <option value="Khamis">Khamis</option> <option value="Jumaat">Jumaat</option> <option value="Sabtu">Sabtu</option> <option value="Ahad">Ahad</option> </select>
       </div>
       <div><label for="admin-category" class="block text-sm font-medium text-gray-700 mb-2">Sesi (Kategori Pelajar) *</label> <select id="admin-category" name="category" required onchange="updateAdminTimeSlots()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"> <option value="">Pilih Sesi</option> <option value="menengah-bawah">Menengah Bawah</option> <option value="menengah-atas">Menengah Atas</option> </select>
       </div>
      </div>
      <div><label for="admin-time-slot" class="block text-sm font-medium text-gray-700 mb-2">Masa *</label> <select id="admin-time-slot" name="timeSlot" required onchange="checkAdminAvailability()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"> <option value="">Pilih sesi terlebih dahulu</option> </select>
       <div id="admin-availability-status" class="mt-2 text-sm"></div>
      </div>
      <div id="admin-custom-time-section" class="hidden"><label for="admin-custom-time" class="block text-sm font-medium text-gray-700 mb-2">Masa Lain-lain</label> <input type="text" id="admin-custom-time" name="customTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white" placeholder="Contoh: 2:00-3:00 petang, 3:00-4:00 petang">
      </div>
      <div><label for="admin-email" class="block text-sm font-medium text-gray-700 mb-2">Email (Opsyenal)</label> <input type="email" id="admin-email" name="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white" placeholder="Untuk notifikasi pengesahan">
      </div>
      <div class="flex gap-4"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg transition-colors"> ğŸ’¾ Simpan Tempahan </button> <button type="button" onclick="closeAdminBookingModal()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 px-6 rounded-lg transition-colors"> Batal </button>
      </div>
     </form>
    </div>
   </div>
  </div><!-- Copyright Footer -->
  <footer class="text-center py-4 mt-8 no-print">
   <p class="text-xs text-gray-500">Â©ï¸ AI.ICTSMANIP</p>
  </footer>
  <script>
        // Real-time cloud database system with Canva Sheet integration
        let bookings = [];
        let nextId = 1;
        let isAdminLoggedIn = false;
        let cloudSyncInterval;
        let lastCloudSync = 0;
        let deviceId = null;
        let isCloudOnline = true;
        let syncCount = 0;
        let activeDevices = new Map();
        
        // Google Sheet Configuration
        const GOOGLE_SHEET_CONFIG = {
            sheetId: 'smanip_booking_sheet_' + Date.now(),
            apiEndpoint: 'https://sheets.googleapis.com/v4/spreadsheets', // Simulated endpoint
            realTimeEndpoint: 'wss://realtime.googleapis.com/sheets', // Simulated WebSocket
            syncInterval: 2000, // 2 seconds for real-time sync
            maxRetries: 3,
            timeout: 10000
        };
        
        let googleSheetConnection = null;
        let isGoogleSheetConnected = false;
        let googleSheetRetries = 0;

        // Time slots for different categories
        const timeSlots = {
            'menengah-bawah': [
                '7:00-8:00 pagi',
                '8:00-9:00 pagi',
                '10:30-11:30 pagi',
                '11:30 pagi-12:30 tengah hari',
                '12:30 tengah hari-1:30 petang'
            ],
            'menengah-atas': [
                '7:00-8:00 pagi',
                '8:00-9:00 pagi',
                '9:00-10:00 pagi',
                '10:30-11:30 pagi',
                '11:30 pagi-12:30 tengah hari',
                '12:30 tengah hari-1:30 petang'
            ]
        };

        const days = ['Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu', 'Ahad'];
        const allDays = ['Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat', 'Sabtu', 'Ahad'];
        const standardTimeSlots = ['7:00-8:00 pagi', '8:00-9:00 pagi', '9:00-10:00 pagi', '10:30-11:30 pagi', '11:30 pagi-12:30 tengah hari', '12:30 tengah hari-1:30 petang'];

        // Initialize Google Sheet connection
        async function initializeGoogleSheet() {
            try {
                updateSyncStatus('syncing', 'Connecting to Google Sheet...');
                
                // Simulate Google Sheet API connection
                const response = await simulateGoogleSheetAPI('connect', {
                    sheetId: GOOGLE_SHEET_CONFIG.sheetId,
                    deviceId: deviceId,
                    timestamp: Date.now()
                });
                
                if (response.success) {
                    isGoogleSheetConnected = true;
                    googleSheetRetries = 0;
                    
                    // Load existing data from Google Sheet
                    await loadFromGoogleSheet();
                    
                    // Start real-time WebSocket connection (simulated)
                    startGoogleSheetRealTime();
                    
                    updateSyncStatus('connected', 'Google Sheet ONLINE');
                    
                    console.log('Google Sheet initialized successfully');
                } else {
                    throw new Error('Failed to connect to Google Sheet');
                }
                
            } catch (error) {
                console.error('Google Sheet initialization failed:', error);
                isGoogleSheetConnected = false;
                googleSheetRetries++;
                
                if (googleSheetRetries < GOOGLE_SHEET_CONFIG.maxRetries) {
                    setTimeout(() => initializeGoogleSheet(), 5000);
                    updateSyncStatus('error', `Retrying Google Sheet (${googleSheetRetries}/${GOOGLE_SHEET_CONFIG.maxRetries})`);
                } else {
                    updateSyncStatus('error', 'Google Sheet OFFLINE');
                }
            }
        }

        // Simulate Google Sheet API calls
        async function simulateGoogleSheetAPI(action, data) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    // Simulate API response
                    const responses = {
                        connect: { success: true, sheetId: GOOGLE_SHEET_CONFIG.sheetId },
                        read: { success: true, data: JSON.parse(localStorage.getItem('google_sheet_data') || '[]') },
                        write: { success: true, rowsAffected: 1 },
                        update: { success: true, rowsUpdated: 1 },
                        delete: { success: true, rowsDeleted: 1 }
                    };
                    
                    resolve(responses[action] || { success: false });
                }, Math.random() * 1000 + 500); // Simulate network delay
            });
        }

        // Load data from Google Sheet
        async function loadFromGoogleSheet() {
            try {
                const response = await simulateGoogleSheetAPI('read', {
                    sheetId: GOOGLE_SHEET_CONFIG.sheetId
                });
                
                if (response.success && response.data) {
                    const sheetData = response.data;
                    
                    // Convert sheet data to bookings format
                    bookings = sheetData.map(row => ({
                        id: row.id || nextId++,
                        teacherName: row.teacherName || '',
                        className: row.className || '',
                        purpose: row.purpose || '',
                        day: row.day || '',
                        timeSlot: row.timeSlot || '',
                        category: row.category || '',
                        email: row.email || '',
                        bookingDate: row.bookingDate || '',
                        timestamp: row.timestamp || new Date().toISOString(),
                        deviceId: row.deviceId || 'unknown',
                        sheetRowId: row.sheetRowId || null
                    }));
                    
                    // Update nextId based on existing data
                    if (bookings.length > 0) {
                        nextId = Math.max(...bookings.map(b => b.id)) + 1;
                    }
                    
                    console.log(`Loaded ${bookings.length} bookings from Google Sheet`);
                }
                
            } catch (error) {
                console.error('Failed to load from Google Sheet:', error);
                throw error;
            }
        }

        // Save data to Google Sheet
        async function saveToGoogleSheet(action, bookingData) {
            if (!isGoogleSheetConnected) {
                console.log('Google Sheet not connected, saving to local storage');
                return false;
            }
            
            try {
                updateSyncStatus('syncing', 'Syncing to Google Sheet...');
                
                // Prepare data for Google Sheet format
                const sheetData = bookings.map(booking => ({
                    id: booking.id,
                    teacherName: booking.teacherName,
                    className: booking.className,
                    purpose: booking.purpose,
                    day: booking.day,
                    timeSlot: booking.timeSlot,
                    category: booking.category,
                    email: booking.email,
                    bookingDate: booking.bookingDate,
                    timestamp: booking.timestamp,
                    deviceId: booking.deviceId,
                    lastModified: new Date().toISOString(),
                    modifiedBy: deviceId
                }));
                
                // Save to simulated Google Sheet storage
                localStorage.setItem('google_sheet_data', JSON.stringify(sheetData));
                
                const response = await simulateGoogleSheetAPI('write', {
                    sheetId: GOOGLE_SHEET_CONFIG.sheetId,
                    data: sheetData,
                    action: action,
                    deviceId: deviceId
                });
                
                if (response.success) {
                    // Broadcast real-time update to all connected devices
                    broadcastGoogleSheetUpdate(action, bookingData);
                    
                    updateSyncStatus('synced', 'Google Sheet synced');
                    
                    return true;
                } else {
                    throw new Error('Google Sheet write failed');
                }
                
            } catch (error) {
                console.error('Failed to save to Google Sheet:', error);
                updateSyncStatus('error', 'Google Sheet sync failed');
                return false;
            }
        }

        // Start real-time Google Sheet connection (WebSocket simulation)
        function startGoogleSheetRealTime() {
            // Simulate WebSocket connection for real-time updates
            googleSheetConnection = {
                connected: true,
                lastPing: Date.now()
            };
            
            // Listen for real-time updates from other devices
            const realTimeInterval = setInterval(async () => {
                if (!isGoogleSheetConnected) {
                    clearInterval(realTimeInterval);
                    return;
                }
                
                try {
                    // Check for updates from Google Sheet
                    await checkGoogleSheetUpdates();
                    
                    // Send heartbeat
                    googleSheetConnection.lastPing = Date.now();
                    
                } catch (error) {
                    console.error('Real-time Google Sheet update failed:', error);
                }
                
            }, GOOGLE_SHEET_CONFIG.syncInterval);
            
            console.log('Google Sheet real-time connection started');
        }

        // Check for updates from Google Sheet
        async function checkGoogleSheetUpdates() {
            try {
                const response = await simulateGoogleSheetAPI('read', {
                    sheetId: GOOGLE_SHEET_CONFIG.sheetId,
                    since: lastCloudSync
                });
                
                if (response.success && response.data) {
                    const sheetData = response.data;
                    const currentDataString = JSON.stringify(bookings.map(b => ({ id: b.id, timestamp: b.timestamp })));
                    const sheetDataString = JSON.stringify(sheetData.map(b => ({ id: b.id, timestamp: b.timestamp })));
                    
                    // Check if data has changed
                    if (currentDataString !== sheetDataString) {
                        // Update local data with Google Sheet data
                        const oldBookingsCount = bookings.length;
                        
                        bookings = sheetData.map(row => ({
                            id: row.id || nextId++,
                            teacherName: row.teacherName || '',
                            className: row.className || '',
                            purpose: row.purpose || '',
                            day: row.day || '',
                            timeSlot: row.timeSlot || '',
                            category: row.category || '',
                            email: row.email || '',
                            bookingDate: row.bookingDate || '',
                            timestamp: row.timestamp || new Date().toISOString(),
                            deviceId: row.deviceId || 'unknown'
                        }));
                        
                        // Update UI
                        refreshAllViews();
                        
                        lastCloudSync = Date.now();
                    }
                }
                
            } catch (error) {
                console.error('Failed to check Google Sheet updates:', error);
            }
        }

        // Broadcast Google Sheet updates to all devices
        function broadcastGoogleSheetUpdate(action, data) {
            const updateEvent = {
                type: 'GOOGLE_SHEET_UPDATE',
                action: action,
                data: data,
                bookings: bookings,
                deviceId: deviceId,
                timestamp: Date.now(),
                sheetId: GOOGLE_SHEET_CONFIG.sheetId
            };
            
            // Broadcast via localStorage for cross-tab communication
            localStorage.setItem('google_sheet_broadcast_' + Date.now(), JSON.stringify(updateEvent));
            
            // Also update the main cloud sync
            localStorage.setItem('smanip_cloud_sync', JSON.stringify(updateEvent));
        }

        // Booking system control
        let isBookingOpen = true;

        // Toggle booking status (admin only)
        async function toggleBookingStatus() {
            if (!isAdminLoggedIn) {
                showErrorModal('Hanya pentadbir boleh mengubah status tempahan.');
                return;
            }
            
            isBookingOpen = !isBookingOpen;
            
            // Save to localStorage and broadcast
            localStorage.setItem('smanip_booking_open', isBookingOpen.toString());
            
            // Broadcast to all devices
            const statusEvent = {
                type: 'BOOKING_STATUS_CHANGE',
                action: 'toggle_booking',
                data: { isOpen: isBookingOpen },
                deviceId: deviceId,
                timestamp: Date.now()
            };
            
            localStorage.setItem('smanip_booking_status_' + Date.now(), JSON.stringify(statusEvent));
            
            // Update UI
            updateBookingStatusUI();
            
            const statusText = isBookingOpen ? 'dibuka' : 'ditutup';
            showCloudNotification(`ğŸ›ï¸ Sistem tempahan ${statusText}`);
        }

        // Update booking status UI
        function updateBookingStatusUI() {
            const statusText = document.getElementById('booking-status-text');
            const toggleBtn = document.getElementById('booking-toggle-btn');
            
            if (isBookingOpen) {
                if (statusText) {
                    statusText.textContent = 'DIBUKA';
                    statusText.className = 'text-lg font-bold text-green-600';
                }
                if (toggleBtn) {
                    toggleBtn.textContent = 'ğŸ”“ Tutup Tempahan';
                    toggleBtn.className = 'bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors';
                }
            } else {
                if (statusText) {
                    statusText.textContent = 'DITUTUP';
                    statusText.className = 'text-lg font-bold text-red-600';
                }
                if (toggleBtn) {
                    toggleBtn.textContent = 'ğŸ”’ Buka Tempahan';
                    toggleBtn.className = 'bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors';
                }
            }
        }

        // Check if booking is allowed
        function checkBookingAccess() {
            if (!isBookingOpen) {
                // Show closed message
                const closedModal = document.createElement('div');
                closedModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                closedModal.innerHTML = `
                    <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center">
                        <div class="text-6xl mb-4">ğŸ”’</div>
                        <h3 class="text-xl font-bold text-red-800 mb-4">Tempahan Ditutup</h3>
                        <p class="text-gray-600 mb-6">Mohon Maaf, Tempahan Bilik Belum dibuka buat masa ini.</p>
                        <button onclick="this.closest('.fixed').remove(); showPage('home')" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                            Kembali ke Utama
                        </button>
                    </div>
                `;
                document.body.appendChild(closedModal);
                return false;
            }
            return true;
        }

        // Initialize cloud database system
        function initializeCloudDatabase() {
            // Generate unique device ID
            deviceId = getDeviceId();
            
            // Load data from cloud (localStorage simulation)
            loadFromCloud();
            
            // Initialize Google Sheet connection
            initializeGoogleSheet();
            
            // Register this device as active
            registerActiveDevice();
            
            // Start real-time cloud sync
            startCloudSync();
            
            // Listen for storage events (cross-tab/cross-device simulation)
            window.addEventListener('storage', handleCloudSync);
            
            // Listen for visibility changes
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Listen for beforeunload to cleanup
            window.addEventListener('beforeunload', cleanupDevice);
            
            // Update sync status
            updateSyncStatus('connected', 'ONLINE');
            
            console.log(`Cloud Database initialized for device: ${deviceId}`);
        }

        // Generate or retrieve unique device ID
        function getDeviceId() {
            let deviceId = localStorage.getItem('smanip_device_id');
            if (!deviceId) {
                deviceId = 'device_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('smanip_device_id', deviceId);
            }
            return deviceId;
        }

        // Load data from cloud (localStorage simulation)
        function loadFromCloud() {
            try {
                const cloudData = localStorage.getItem('smanip_cloud_bookings');
                const cloudNextId = localStorage.getItem('smanip_cloud_next_id');
                const cloudLastSync = localStorage.getItem('smanip_cloud_last_sync');
                
                if (cloudData) {
                    bookings = JSON.parse(cloudData);
                    nextId = parseInt(cloudNextId) || 1;
                    lastCloudSync = parseInt(cloudLastSync) || Date.now();
                }
                
                console.log(`Loaded ${bookings.length} bookings from cloud`);
                showCloudNotification('â˜ï¸ Data dimuat dari cloud');
                
            } catch (error) {
                console.error('Failed to load from cloud:', error);
                isCloudOnline = false;
                updateSyncStatus('error', 'Gagal sambung cloud');
            }
        }

        // Save data to cloud and Canva Sheet, then broadcast to all devices
        async function saveToCloud(action = 'update', data = null) {
            try {
                updateSyncStatus('syncing', 'Menyimpan ke cloud & Canva Sheet...');
                
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Save to cloud (localStorage simulation)
                localStorage.setItem('smanip_cloud_bookings', JSON.stringify(bookings));
                localStorage.setItem('smanip_cloud_next_id', nextId.toString());
                localStorage.setItem('smanip_cloud_last_sync', Date.now().toString());
                
                // Save to Google Sheet (priority sync)
                let googleSheetSuccess = false;
                if (isGoogleSheetConnected) {
                    googleSheetSuccess = await saveToGoogleSheet(action, data);
                }
                
                // Create cloud sync event
                const syncEvent = {
                    type: 'CLOUD_SYNC',
                    action: action,
                    data: data,
                    bookings: bookings,
                    nextId: nextId,
                    deviceId: deviceId,
                    timestamp: Date.now(),
                    googleSheetSynced: googleSheetSuccess
                };
                
                // Broadcast to all devices via multiple channels
                localStorage.setItem('smanip_cloud_sync', JSON.stringify(syncEvent));
                localStorage.setItem('smanip_cloud_broadcast_' + Date.now(), JSON.stringify(syncEvent));
                
                // Update sync count
                syncCount++;
                lastCloudSync = Date.now();
                
                const syncStatus = googleSheetSuccess ? 'Cloud & Google Sheet synced' : 'Cloud synced (Google Sheet offline)';
                updateSyncStatus('synced', syncStatus);
                
                // Update admin panel if visible
                if (isAdminLoggedIn) {
                    updateCloudStatus();
                }
                
                // Clear old broadcast messages
                cleanupOldBroadcasts();
                
            } catch (error) {
                console.error('Failed to save to cloud:', error);
                isCloudOnline = false;
                updateSyncStatus('error', 'Gagal simpan ke cloud');
            }
        }

        // Handle cloud sync events from other devices
        function handleCloudSync(event) {
            // Handle all cloud sync events
            if (event.key && event.key.startsWith('smanip_cloud_') && event.newValue) {
                try {
                    const syncEvent = JSON.parse(event.newValue);
                    
                    // Ignore events from this device
                    if (syncEvent.deviceId === deviceId) return;
                    
                    // Check if this is a newer update
                    if (syncEvent.timestamp > lastCloudSync) {
                        // Update local data
                        bookings = syncEvent.bookings || bookings;
                        nextId = syncEvent.nextId || nextId;
                        lastCloudSync = syncEvent.timestamp;
                        
                        // Refresh UI
                        refreshAllViews();
                        
                        updateSyncStatus('synced', 'ONLINE');
                        
                        console.log(`Received cloud sync from ${syncEvent.deviceId}: ${syncEvent.action}`);
                    }
                    
                } catch (error) {
                    console.error('Failed to handle cloud sync:', error);
                }
            }
            
            // Handle active devices updates
            if (event.key === 'smanip_active_devices' && event.newValue) {
                updateActiveDevicesList();
            }
            
            // Handle booking status changes
            if (event.key && event.key.startsWith('smanip_booking_status_') && event.newValue) {
                try {
                    const statusEvent = JSON.parse(event.newValue);
                    
                    // Ignore events from this device
                    if (statusEvent.deviceId === deviceId) return;
                    
                    isBookingOpen = statusEvent.data.isOpen;
                    updateBookingStatusUI();
                    
                    const statusText = isBookingOpen ? 'dibuka' : 'ditutup';
                    const deviceName = statusEvent.deviceId.replace('device_', 'Device ');
                    showCloudNotification(`ğŸ“± Sistem tempahan ${statusText} dari ${deviceName}`);
                    
                } catch (error) {
                    console.error('Failed to handle booking status sync:', error);
                }
            }
            
            // Handle direct booking status changes
            if (event.key === 'smanip_booking_open' && event.newValue !== null) {
                isBookingOpen = event.newValue === 'true';
                updateBookingStatusUI();
            }
            
            // Handle settings broadcast events
            if (event.key && (event.key.startsWith('smanip_cloud_settings_') || 
                             event.key.startsWith('smanip_cloud_logo_') || 
                             event.key.startsWith('smanip_cloud_bg_')) && event.newValue) {
                try {
                    const settingsEvent = JSON.parse(event.newValue);
                    
                    // Ignore events from this device
                    if (settingsEvent.deviceId === deviceId) return;
                    
                    const deviceName = settingsEvent.deviceId.replace('device_', 'Device ');
                    
                    switch (settingsEvent.action) {
                        case 'update_homepage':
                            document.getElementById('homepage-title').textContent = settingsEvent.data.title;
                            document.getElementById('homepage-description').textContent = settingsEvent.data.description;
                            showCloudNotification(`ğŸ“± Homepage dikemaskini dari ${deviceName}`);
                            break;
                            
                        case 'update_logo':
                            const logoImg = document.getElementById('school-logo');
                            const defaultIcon = document.getElementById('default-icon');
                            logoImg.src = settingsEvent.data.logo;
                            logoImg.classList.remove('hidden');
                            defaultIcon.classList.add('hidden');
                            showCloudNotification(`ğŸ“± Logo dikemaskini dari ${deviceName}`);
                            break;
                            
                        case 'remove_logo':
                            const logoImg2 = document.getElementById('school-logo');
                            const defaultIcon2 = document.getElementById('default-icon');
                            logoImg2.src = '';
                            logoImg2.classList.add('hidden');
                            defaultIcon2.classList.remove('hidden');
                            showCloudNotification(`ğŸ“± Logo dibuang dari ${deviceName}`);
                            break;
                            
                        case 'update_background':
                            const bg = settingsEvent.data.background;
                            if (bg.startsWith('data:')) {
                                document.documentElement.style.setProperty('--custom-bg', `url(${bg})`);
                            } else {
                                document.documentElement.style.setProperty('--custom-bg', bg);
                            }
                            showCloudNotification(`ğŸ“± Latar belakang dikemaskini dari ${deviceName}`);
                            break;
                            
                        case 'remove_background':
                            document.documentElement.style.setProperty('--custom-bg', settingsEvent.data.background);
                            showCloudNotification(`ğŸ“± Latar belakang direset dari ${deviceName}`);
                            break;
                    }
                    
                } catch (error) {
                    console.error('Failed to handle settings sync:', error);
                }
            }
            
            // Handle direct localStorage changes (fallback)
            if (event.key === 'smanip_homepage_title' && event.newValue) {
                document.getElementById('homepage-title').textContent = event.newValue;
                showCloudNotification('ğŸ“± Tajuk homepage dikemaskini');
            }
            
            if (event.key === 'smanip_homepage_description' && event.newValue) {
                document.getElementById('homepage-description').textContent = event.newValue;
                showCloudNotification('ğŸ“± Penerangan homepage dikemaskini');
            }
            
            if (event.key === 'smanip_school_logo') {
                const logoImg = document.getElementById('school-logo');
                const defaultIcon = document.getElementById('default-icon');
                
                if (event.newValue) {
                    logoImg.src = event.newValue;
                    logoImg.classList.remove('hidden');
                    defaultIcon.classList.add('hidden');
                    showCloudNotification('ğŸ“± Logo sekolah dikemaskini');
                } else {
                    logoImg.src = '';
                    logoImg.classList.add('hidden');
                    defaultIcon.classList.remove('hidden');
                    showCloudNotification('ğŸ“± Logo sekolah dibuang');
                }
            }
            
            if (event.key === 'smanip_bg' || event.key === 'smanip_custom_bg') {
                if (event.newValue) {
                    if (event.newValue.startsWith('data:')) {
                        document.documentElement.style.setProperty('--custom-bg', `url(${event.newValue})`);
                    } else {
                        document.documentElement.style.setProperty('--custom-bg', event.newValue);
                    }
                    showCloudNotification('ğŸ“± Latar belakang dikemaskini');
                } else {
                    document.documentElement.style.setProperty('--custom-bg', 'linear-gradient(135deg, #f0fdf4, #dcfce7)');
                    showCloudNotification('ğŸ“± Latar belakang direset');
                }
            }
        }

        // Register this device as active
        function registerActiveDevice() {
            try {
                const deviceInfo = {
                    id: deviceId,
                    name: deviceId.replace('device_', 'Device '),
                    lastSeen: Date.now(),
                    userAgent: navigator.userAgent.substring(0, 50) + '...',
                    isAdmin: isAdminLoggedIn,
                    timestamp: new Date().toLocaleString('ms-MY')
                };
                
                // Get current active devices
                const activeDevicesData = JSON.parse(localStorage.getItem('smanip_active_devices') || '{}');
                activeDevicesData[deviceId] = deviceInfo;
                
                // Clean up old devices (older than 5 minutes)
                const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
                Object.keys(activeDevicesData).forEach(id => {
                    if (activeDevicesData[id].lastSeen < fiveMinutesAgo) {
                        delete activeDevicesData[id];
                    }
                });
                
                // Save back to localStorage
                localStorage.setItem('smanip_active_devices', JSON.stringify(activeDevicesData));
                
                // Update local active devices map
                activeDevices.clear();
                Object.values(activeDevicesData).forEach(device => {
                    activeDevices.set(device.id, device);
                });
                
                // Update admin panel if visible
                if (isAdminLoggedIn) {
                    updateActiveDevicesList();
                    updateCloudStatus();
                }
                
            } catch (error) {
                console.error('Failed to register active device:', error);
            }
        }

        // Start real-time cloud sync
        function startCloudSync() {
            // Aggressive sync every 1 second for real-time updates
            cloudSyncInterval = setInterval(async () => {
                await registerActiveDevice();
                await checkForCloudUpdates();
                updateUserCount();
            }, 1000);
            
            // Heartbeat every 30 seconds
            setInterval(() => {
                if (isCloudOnline) {
                    registerActiveDevice();
                }
            }, 30000);
        }

        // Check for cloud updates
        async function checkForCloudUpdates() {
            try {
                const cloudLastSync = parseInt(localStorage.getItem('smanip_cloud_last_sync') || '0');
                
                if (cloudLastSync > lastCloudSync) {
                    // There are newer updates in the cloud
                    await loadFromCloud();
                    refreshAllViews();
                    showCloudNotification('âš¡ Sync automatik dari cloud');
                }
                
                // Check for broadcast messages
                const broadcastKeys = Object.keys(localStorage).filter(key => 
                    key.startsWith('smanip_cloud_broadcast_')
                );
                
                broadcastKeys.forEach(key => {
                    try {
                        const broadcastData = JSON.parse(localStorage.getItem(key));
                        if (broadcastData && 
                            broadcastData.deviceId !== deviceId && 
                            broadcastData.timestamp > lastCloudSync) {
                            
                            // Process the broadcast
                            bookings = broadcastData.bookings || bookings;
                            nextId = broadcastData.nextId || nextId;
                            lastCloudSync = broadcastData.timestamp;
                            
                            refreshAllViews();
                            
                            const deviceName = broadcastData.deviceId.replace('device_', '');
                            showCloudNotification(`ï¿½ï¿½ï¿½ï¿½ Sync dari ${deviceName}`);
                        }
                    } catch (error) {
                        console.error('Error processing broadcast:', error);
                    }
                });
                
                // Check for homepage settings updates
                const currentTitle = document.getElementById('homepage-title').textContent;
                const currentDescription = document.getElementById('homepage-description').textContent;
                const savedTitle = localStorage.getItem('smanip_homepage_title');
                const savedDescription = localStorage.getItem('smanip_homepage_description');
                
                if (savedTitle && savedTitle !== currentTitle) {
                    document.getElementById('homepage-title').textContent = savedTitle;
                    showCloudNotification('ğŸ“± Tajuk homepage dikemaskini');
                }
                
                if (savedDescription && savedDescription !== currentDescription) {
                    document.getElementById('homepage-description').textContent = savedDescription;
                    showCloudNotification('ğŸ“± Penerangan homepage dikemaskini');
                }
                
                // Check for logo updates
                const savedLogo = localStorage.getItem('smanip_school_logo');
                const currentLogo = document.getElementById('school-logo').src;
                
                if (savedLogo && savedLogo !== currentLogo) {
                    const logoImg = document.getElementById('school-logo');
                    const defaultIcon = document.getElementById('default-icon');
                    logoImg.src = savedLogo;
                    logoImg.classList.remove('hidden');
                    defaultIcon.classList.add('hidden');
                    showCloudNotification('ğŸ“± Logo sekolah dikemaskini');
                } else if (!savedLogo && currentLogo) {
                    const logoImg = document.getElementById('school-logo');
                    const defaultIcon = document.getElementById('default-icon');
                    logoImg.src = '';
                    logoImg.classList.add('hidden');
                    defaultIcon.classList.remove('hidden');
                    showCloudNotification('ğŸ“± Logo sekolah dibuang');
                }
                
                // Check for background updates
                const savedBg = localStorage.getItem('smanip_bg') || localStorage.getItem('smanip_custom_bg');
                const currentBg = document.documentElement.style.getPropertyValue('--custom-bg');
                
                if (savedBg && !currentBg.includes(savedBg.substring(0, 20))) {
                    if (savedBg.startsWith('data:')) {
                        document.documentElement.style.setProperty('--custom-bg', `url(${savedBg})`);
                    } else {
                        document.documentElement.style.setProperty('--custom-bg', savedBg);
                    }
                    showCloudNotification('ğŸ“± Latar belakang dikemaskini');
                }
                
                isCloudOnline = true;
                
            } catch (error) {
                console.error('Failed to check cloud updates:', error);
                isCloudOnline = false;
            }
        }

        // Manual sync function
        async function manualSync() {
            updateSyncStatus('syncing', 'Sync manual...');
            
            try {
                await loadFromCloud();
                await checkForCloudUpdates();
                await registerActiveDevice();
                
                refreshAllViews();
                
                updateSyncStatus('connected', 'ONLINE');
                showCloudNotification('ï¿½ï¿½ Sync manual selesai');
                
            } catch (error) {
                console.error('Manual sync failed:', error);
                updateSyncStatus('error', 'Gagal sync manual');
            }
        }

        // Force cloud sync (for admin)
        async function forceCloudSync() {
            updateSyncStatus('syncing', 'Sync cloud paksa...');
            
            try {
                // Force save current data to cloud
                await saveToCloud('force_sync');
                
                // Force load from cloud
                await loadFromCloud();
                
                // Force check for updates
                await checkForCloudUpdates();
                
                // Force register device
                await registerActiveDevice();
                
                refreshAllViews();
                
                updateSyncStatus('connected', 'ONLINE');
                showCloudNotification('ğŸš€ Sync cloud paksa selesai');
                
            } catch (error) {
                console.error('Force cloud sync failed:', error);
                updateSyncStatus('error', 'Gagal sync cloud paksa');
            }
        }

        // Auto sync function (enhanced)
        async function forceSync() {
            updateSyncStatus('syncing', 'Auto sync...');
            
            try {
                await loadFromCloud();
                await checkForCloudUpdates();
                await registerActiveDevice();
                
                refreshAllViews();
                
                updateSyncStatus('connected', 'ONLINE');
                showCloudNotification('ğŸš€ Auto sync selesai');
                
            } catch (error) {
                console.error('Auto sync failed:', error);
                updateSyncStatus('error', 'Gagal auto sync');
            }
        }

        // Update cloud status in admin panel
        function updateCloudStatus() {
            if (!isAdminLoggedIn) return;
            
            // Update cloud status
            const cloudStatusElement = document.getElementById('cloud-status');
            if (cloudStatusElement) {
                cloudStatusElement.textContent = isCloudOnline ? 'ONLINE' : 'OFFLINE';
                cloudStatusElement.className = isCloudOnline ? 
                    'text-2xl font-bold text-green-600' : 
                    'text-2xl font-bold text-red-600';
            }
            
            // Update active devices count
            const activeDevicesElement = document.getElementById('active-devices');
            if (activeDevicesElement) {
                activeDevicesElement.textContent = activeDevices.size;
            }
            
            // Update last sync time
            const lastSyncElement = document.getElementById('last-sync-time');
            if (lastSyncElement) {
                const timeDiff = Date.now() - lastCloudSync;
                if (timeDiff < 60000) {
                    lastSyncElement.textContent = 'Baru';
                } else if (timeDiff < 3600000) {
                    lastSyncElement.textContent = Math.floor(timeDiff / 60000) + 'm';
                } else {
                    lastSyncElement.textContent = Math.floor(timeDiff / 3600000) + 'h';
                }
            }
            
            // Update sync count
            const syncCountElement = document.getElementById('sync-count');
            if (syncCountElement) {
                syncCountElement.textContent = syncCount;
            }
            
            // Update Canva Sheet status
            updateCanvaSheetStatus();
        }

        // Update Canva Sheet status in admin panel
        function updateCanvaSheetStatus() {
            if (!isAdminLoggedIn) return;
            
            // Update Canva Sheet status
            const canvaSheetStatusElement = document.getElementById('canva-sheet-status');
            if (canvaSheetStatusElement) {
                canvaSheetStatusElement.textContent = isCanvaSheetConnected ? 'ONLINE' : 'OFFLINE';
                canvaSheetStatusElement.className = isCanvaSheetConnected ? 
                    'text-2xl font-bold text-green-600' : 
                    'text-2xl font-bold text-red-600';
            }
            
            // Update records count
            const canvaSheetRecordsElement = document.getElementById('canva-sheet-records');
            if (canvaSheetRecordsElement) {
                canvaSheetRecordsElement.textContent = bookings.length;
            }
            
            // Update last sheet sync time
            const canvaSheetSyncTimeElement = document.getElementById('canva-sheet-sync-time');
            if (canvaSheetSyncTimeElement) {
                const timeDiff = Date.now() - lastCloudSync;
                if (timeDiff < 60000) {
                    canvaSheetSyncTimeElement.textContent = 'Baru';
                } else if (timeDiff < 3600000) {
                    canvaSheetSyncTimeElement.textContent = Math.floor(timeDiff / 60000) + 'm';
                } else {
                    canvaSheetSyncTimeElement.textContent = Math.floor(timeDiff / 3600000) + 'h';
                }
            }
            
            // Update connected devices count (simulated)
            const canvaSheetDevicesElement = document.getElementById('canva-sheet-devices');
            if (canvaSheetDevicesElement) {
                canvaSheetDevicesElement.textContent = activeDevices.size;
            }
            
            // Update Sheet ID
            const canvaSheetIdElement = document.getElementById('canva-sheet-id');
            if (canvaSheetIdElement) {
                canvaSheetIdElement.textContent = CANVA_SHEET_CONFIG.sheetId;
            }
        }

        // Reconnect to Canva Sheet
        async function reconnectCanvaSheet() {
            updateSyncStatus('syncing', 'Reconnecting to Canva Sheet...');
            
            try {
                isCanvaSheetConnected = false;
                canvaSheetRetries = 0;
                
                await initializeCanvaSheet();
                
                if (isCanvaSheetConnected) {
                    showCanvaSheetNotification('ğŸ”„ Canva Sheet reconnected successfully');
                } else {
                    showCanvaSheetNotification('ï¿½ï¿½ï¿½ Failed to reconnect to Canva Sheet');
                }
                
            } catch (error) {
                console.error('Reconnect failed:', error);
                showCanvaSheetNotification('âŒ Reconnection failed');
            }
        }

        // Force Canva Sheet sync
        async function forceCanvaSheetSync() {
            if (!isCanvaSheetConnected) {
                showCanvaSheetNotification('âŒ Canva Sheet not connected');
                return;
            }
            
            updateSyncStatus('syncing', 'Force syncing Canva Sheet...');
            
            try {
                // Force save all data to Canva Sheet
                const success = await saveToCanvaSheet('force_sync', null);
                
                if (success) {
                    // Force load from Canva Sheet
                    await loadFromCanvaSheet();
                    
                    refreshAllViews();
                    showCanvaSheetNotification('ğŸš€ Canva Sheet force sync completed');
                } else {
                    showCanvaSheetNotification('âŒ Force sync failed');
                }
                
            } catch (error) {
                console.error('Force sync failed:', error);
                showCanvaSheetNotification('âŒ Force sync error');
            }
        }

        // Export current data to Canva Sheet
        async function exportToCanvaSheet() {
            if (!isCanvaSheetConnected) {
                showCanvaSheetNotification('âŒ Canva Sheet not connected');
                return;
            }
            
            if (bookings.length === 0) {
                showCanvaSheetNotification('âŒ No data to export');
                return;
            }
            
            updateSyncStatus('syncing', 'Exporting to Canva Sheet...');
            
            try {
                const success = await saveToCanvaSheet('export_all', bookings);
                
                if (success) {
                    showCanvaSheetNotification(`ğŸ“¤ ${bookings.length} records exported to Canva Sheet`);
                } else {
                    showCanvaSheetNotification('âŒ Export failed');
                }
                
            } catch (error) {
                console.error('Export failed:', error);
                showCanvaSheetNotification('âŒ Export error');
            }
        }

        // Import data from Canva Sheet
        async function importFromCanvaSheet() {
            if (!isCanvaSheetConnected) {
                showCanvaSheetNotification('âŒ Canva Sheet not connected');
                return;
            }
            
            updateSyncStatus('syncing', 'Importing from Canva Sheet...');
            
            try {
                const oldCount = bookings.length;
                
                await loadFromCanvaSheet();
                
                const newCount = bookings.length;
                const imported = Math.abs(newCount - oldCount);
                
                refreshAllViews();
                
                if (imported > 0) {
                    showCanvaSheetNotification(`ğŸ“¥ ${imported} records imported from Canva Sheet`);
                } else {
                    showCanvaSheetNotification('ğŸ“¥ No new records to import');
                }
                
            } catch (error) {
                console.error('Import failed:', error);
                showCanvaSheetNotification('âŒ Import error');
            }
        }

        // Update active devices list in admin panel
        function updateActiveDevicesList() {
            if (!isAdminLoggedIn) return;
            
            const activeDevicesListElement = document.getElementById('active-devices-list');
            if (!activeDevicesListElement) return;
            
            // Get current active devices
            const activeDevicesData = JSON.parse(localStorage.getItem('smanip_active_devices') || '{}');
            
            if (Object.keys(activeDevicesData).length === 0) {
                activeDevicesListElement.innerHTML = '<div class="text-gray-500 text-center py-4">Tiada peranti aktif</div>';
                return;
            }
            
            activeDevicesListElement.innerHTML = Object.values(activeDevicesData).map(device => {
                const isCurrentDevice = device.id === deviceId;
                const timeDiff = Date.now() - device.lastSeen;
                const timeAgo = timeDiff < 60000 ? 'Baru sahaja' : 
                               timeDiff < 3600000 ? Math.floor(timeDiff / 60000) + ' minit lalu' :
                               Math.floor(timeDiff / 3600000) + ' jam lalu';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-white/80 rounded-lg border ${isCurrentDevice ? 'border-green-300 bg-green-50/80' : 'border-gray-200'}">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full ${timeDiff < 60000 ? 'bg-green-500 animate-pulse' : 'bg-gray-400'}"></div>
                            <div>
                                <div class="font-medium text-gray-800">
                                    ${device.name} ${isCurrentDevice ? '(Peranti Ini)' : ''}
                                    ${device.isAdmin ? 'ğŸ‘‘' : ''}
                                </div>
                                <div class="text-xs text-gray-500">${device.userAgent}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-medium text-gray-600">${timeAgo}</div>
                            <div class="text-xs text-gray-500">${device.timestamp}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Clean up old broadcast messages
        function cleanupOldBroadcasts() {
            const broadcastKeys = Object.keys(localStorage).filter(key => 
                key.startsWith('smanip_cloud_broadcast_')
            );
            
            // Keep only the last 10 broadcasts
            if (broadcastKeys.length > 10) {
                broadcastKeys.sort().slice(0, -10).forEach(key => {
                    localStorage.removeItem(key);
                });
            }
        }

        // Clean up device on page unload
        function cleanupDevice() {
            try {
                const activeDevicesData = JSON.parse(localStorage.getItem('smanip_active_devices') || '{}');
                delete activeDevicesData[deviceId];
                localStorage.setItem('smanip_active_devices', JSON.stringify(activeDevicesData));
            } catch (error) {
                console.error('Failed to cleanup device:', error);
            }
        }

        // Handle visibility change
        function handleVisibilityChange() {
            if (!document.hidden) {
                // Tab became visible, force sync
                registerActiveDevice();
                checkForCloudUpdates();
            }
        }

        // Show cloud notification (disabled)
        function showCloudNotification(message) {
            // Notifications disabled
        }

        // Show Canva Sheet notification (disabled)
        function showCanvaSheetNotification(message) {
            // Notifications disabled
        }

        // Enhanced user count with real active devices
        function updateUserCount() {
            try {
                const activeDevicesData = JSON.parse(localStorage.getItem('smanip_active_devices') || '{}');
                const now = Date.now();
                const fiveMinutesAgo = now - (5 * 60 * 1000);
                
                // Count devices active in last 5 minutes
                const activeCount = Object.values(activeDevicesData).filter(device => 
                    device.lastSeen > fiveMinutesAgo
                ).length;
                
                const userCountElement = document.getElementById('user-count');
                if (userCountElement) {
                    userCountElement.textContent = `${Math.max(1, activeCount)} pengguna`;
                }
                
            } catch (error) {
                console.error('Failed to update user count:', error);
                const userCountElement = document.getElementById('user-count');
                if (userCountElement) {
                    userCountElement.textContent = '1 pengguna';
                }
            }
        }

        function refreshAllViews() {
            updateStats();
            renderSchedule();
            if (isAdminLoggedIn) {
                renderAdminTable();
                updateCloudStatus();
                updateActiveDevicesList();
            }
        }

        function updateSyncStatus(status, text) {
            const indicator = document.getElementById('sync-indicator');
            const textElement = document.getElementById('sync-text');
            
            indicator.className = 'w-3 h-3 rounded-full';
            
            switch (status) {
                case 'connected':
                    indicator.classList.add('bg-green-500', 'animate-pulse');
                    break;
                case 'synced':
                    indicator.classList.add('bg-blue-500');
                    setTimeout(() => updateSyncStatus('connected', 'ONLINE'), 1000);
                    break;
                case 'syncing':
                    indicator.classList.add('bg-yellow-500', 'animate-spin');
                    break;
                case 'offline':
                    indicator.classList.add('bg-gray-500');
                    break;
                case 'error':
                    indicator.classList.add('bg-red-500', 'animate-pulse');
                    break;
            }
            
            textElement.textContent = text;
            
            // Update Canva Sheet status indicator
            updateCanvaSyncIndicator();
        }

        function updateCanvaSyncIndicator() {
            const canvaIndicator = document.getElementById('canva-sync-indicator');
            const canvaText = document.getElementById('canva-sync-text');
            const canvaRecordCount = document.getElementById('canva-record-count');
            
            if (canvaIndicator && canvaText && canvaRecordCount) {
                canvaIndicator.className = 'w-2 h-2 rounded-full';
                
                if (isCanvaSheetConnected) {
                    canvaIndicator.classList.add('bg-purple-500', 'animate-pulse');
                    canvaText.textContent = 'Canva Sheet ONLINE';
                    canvaText.className = 'text-xs text-purple-700 font-medium';
                } else {
                    canvaIndicator.classList.add('bg-gray-400');
                    canvaText.textContent = 'Canva Sheet OFFLINE';
                    canvaText.className = 'text-xs text-gray-500 font-medium';
                }
                
                canvaRecordCount.textContent = `${bookings.length} records`;
                canvaRecordCount.className = isCanvaSheetConnected ? 
                    'text-xs text-purple-600 bg-purple-100 px-2 py-1 rounded-full' :
                    'text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full';
            }
        }

        // Background customizer
        function toggleBgCustomizer() {
            const options = document.getElementById('bg-options');
            options.classList.toggle('hidden');
        }

        function changeBg(gradient) {
            document.documentElement.style.setProperty('--custom-bg', gradient);
            localStorage.setItem('smanip_bg', gradient);
            document.getElementById('bg-options').classList.add('hidden');
        }

        // Show specific page
        function showPage(pageId) {
            // Check if trying to access booking page when closed
            if (pageId === 'booking' && !isBookingOpen) {
                if (!checkBookingAccess()) {
                    return;
                }
            }
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId + '-page').classList.remove('hidden');
            
            if (pageId === 'home') {
                updateStats();
            } else if (pageId === 'schedule') {
                renderSchedule();
            } else if (pageId === 'admin') {
                if (isAdminLoggedIn) {
                    document.getElementById('admin-login').classList.add('hidden');
                    document.getElementById('admin-panel').classList.remove('hidden');
                    renderAdminTable();
                    updateCloudStatus();
                    updateActiveDevicesList();
                } else {
                    document.getElementById('admin-login').classList.remove('hidden');
                    document.getElementById('admin-panel').classList.add('hidden');
                }
            }
        }

        // Update statistics
        function updateStats() {
            const totalBookings = bookings.length;
            const today = new Date().toLocaleDateString('ms-MY');
            const todayBookings = bookings.filter(b => b.bookingDate === today).length;
            const totalSlots = 7 * 6; // 7 days * 6 time slots
            const usageRate = totalSlots > 0 ? Math.round((totalBookings / totalSlots) * 100) : 0;
            const availableSlots = totalSlots - totalBookings;

            document.getElementById('total-bookings').textContent = totalBookings;
            document.getElementById('today-bookings').textContent = todayBookings;
            document.getElementById('available-slots').textContent = availableSlots;
            document.getElementById('usage-rate').textContent = usageRate + '%';
        }

        // Update time slots based on category
        function updateTimeSlots() {
            const category = document.getElementById('category').value;
            const timeSlotSelect = document.getElementById('time-slot');
            
            timeSlotSelect.innerHTML = '<option value="">Pilih Masa</option>';
            
            if (category && timeSlots[category]) {
                timeSlots[category].forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot;
                    option.textContent = slot;
                    timeSlotSelect.appendChild(option);
                });
                
                const customOption = document.createElement('option');
                customOption.value = 'custom';
                customOption.textContent = 'Lain-lain masa (custom)';
                timeSlotSelect.appendChild(customOption);
            }
        }
        
        document.getElementById('time-slot').addEventListener('change', function() {
            const customTimeSection = document.getElementById('custom-time-section');
            if (this.value === 'custom') {
                customTimeSection.classList.remove('hidden');
            } else {
                customTimeSection.classList.add('hidden');
                document.getElementById('custom-time').value = '';
            }
            checkAvailability();
        });

        // Check availability
        function checkAvailability() {
            const day = document.getElementById('day').value;
            const timeSlot = document.getElementById('time-slot').value;
            const customTime = document.getElementById('custom-time').value;
            const statusDiv = document.getElementById('availability-status');

            if (day && timeSlot) {
                let actualTimeSlot = timeSlot;
                if (timeSlot === 'custom' && customTime) {
                    actualTimeSlot = customTime;
                }
                
                const existingBooking = bookings.find(b => b.day === day && b.timeSlot === actualTimeSlot);
                if (existingBooking) {
                    statusDiv.innerHTML = `<span class="text-red-600 font-medium">âŒ Telah ditempah oleh ${existingBooking.teacherName} (${existingBooking.className})</span>`;
                } else {
                    statusDiv.innerHTML = `<span class="text-green-600 font-medium">ï¿½ï¿½ï¿½ Slot tersedia</span>`;
                }
            } else {
                statusDiv.innerHTML = '';
            }
        }

        // Handle form submission with cloud sync
        document.getElementById('booking-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            updateSyncStatus('syncing', 'Menyimpan...');
            
            const formData = new FormData(e.target);
            let timeSlot = formData.get('timeSlot');
            const customTime = formData.get('customTime');
            
            if (timeSlot === 'custom' && customTime) {
                timeSlot = customTime;
            } else if (timeSlot === 'custom' && !customTime) {
                showErrorModal('Sila masukkan masa custom.');
                updateSyncStatus('connected', 'ONLINE');
                return;
            }
            
            const booking = {
                id: nextId++,
                teacherName: formData.get('teacherName'),
                className: formData.get('className'),
                purpose: formData.get('purpose'),
                day: formData.get('day'),
                timeSlot: timeSlot,
                category: formData.get('category'),
                email: formData.get('email') || '',
                bookingDate: new Date().toLocaleDateString('ms-MY'),
                timestamp: new Date().toISOString(),
                deviceId: deviceId
            };

            try {
                // Check if slot is already booked (real-time check from cloud)
                await loadFromCloud();
                
                const existingBooking = bookings.find(b => 
                    b.day === booking.day && b.timeSlot === booking.timeSlot
                );

                if (existingBooking) {
                    showErrorModal(`Masa ${booking.timeSlot} pada hari ${booking.day} telah ditempah oleh ${existingBooking.teacherName} (${existingBooking.className}).`);
                    updateSyncStatus('connected', 'ONLINE');
                    return;
                }

                // Add booking
                bookings.push(booking);
                
                // Save to cloud and broadcast to all devices
                await saveToCloud('add_booking', booking);

                // Send email notification (simulated)
                if (booking.email) {
                    simulateEmailNotification(booking);
                }

                showSuccessModal(`Tempahan berjaya! Tempahan anda berjaya disimpan untuk ${booking.day}, ${booking.timeSlot}. ${booking.email ? 'Email pengesahan telah dihantar.' : ''}`);
                
                e.target.reset();
                document.getElementById('custom-time-section').classList.add('hidden');
                updateTimeSlots();
                document.getElementById('availability-status').innerHTML = '';
                
                refreshAllViews();
                
            } catch (error) {
                console.error('Failed to save booking:', error);
                showErrorModal('Gagal menyimpan tempahan. Cuba lagi.');
                updateSyncStatus('error', 'Ralat');
            }
        });

        // Simulate email notification
        function simulateEmailNotification(booking) {
            console.log(`Email sent to ${booking.email}:`);
            console.log(`Subject: Pengesahan Tempahan SMANIP`);
            console.log(`Body: Tempahan anda untuk ${booking.day}, ${booking.timeSlot} telah berjaya disimpan.`);
        }

        // Render schedule table
        function renderSchedule() {
            const tableBody = document.getElementById('schedule-table');
            tableBody.innerHTML = '';

            updateWeekDates();

            const afternoonBookings = bookings.filter(b => {
                return !standardTimeSlots.includes(b.timeSlot) && 
                       (b.timeSlot.includes('2:') || b.timeSlot.includes('3:') || 
                        b.timeSlot.includes('4:') || b.timeSlot.includes('5:') || 
                        b.timeSlot.includes('6:') || b.timeSlot.includes('petang'));
            });

            const customHeader = document.getElementById('custom-time-header');
            if (afternoonBookings.length > 0) {
                customHeader.classList.remove('hidden');
            } else {
                customHeader.classList.add('hidden');
            }

            // Always show all 7 days
            days.forEach(day => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const dayCell = document.createElement('td');
                dayCell.className = 'border border-gray-300 px-4 py-3 font-medium bg-gray-50';
                const dayDate = getDayDate(day);
                dayCell.innerHTML = `<div class="font-semibold">${day}</div><div class="text-xs text-gray-500">${dayDate}</div>`;
                row.appendChild(dayCell);

                standardTimeSlots.forEach(timeSlot => {
                    const timeCell = document.createElement('td');
                    timeCell.className = 'border border-gray-300 px-2 py-3 text-center slot-hover cursor-pointer';
                    
                    const booking = bookings.find(b => b.day === day && b.timeSlot === timeSlot);
                    
                    if (booking) {
                        timeCell.className += ' slot-booked';
                        timeCell.innerHTML = `
                            <div class="text-xs font-semibold">${booking.teacherName}</div>
                            <div class="text-xs">${booking.className}</div>
                        `;
                        timeCell.onclick = () => showBookingDetails(booking);
                    } else {
                        timeCell.className += ' slot-available';
                        timeCell.innerHTML = '<div class="text-xs font-semibold">KOSONG</div>';
                        timeCell.title = 'Slot kosong - boleh ditempah';
                    }
                    
                    row.appendChild(timeCell);
                });

                if (afternoonBookings.length > 0) {
                    const customCell = document.createElement('td');
                    customCell.className = 'border border-gray-300 px-2 py-3 text-center';
                    
                    const dayAfternoonBookings = bookings.filter(b => {
                        return b.day === day && !standardTimeSlots.includes(b.timeSlot) && 
                               (b.timeSlot.includes('2:') || b.timeSlot.includes('3:') || 
                                b.timeSlot.includes('4:') || b.timeSlot.includes('5:') || 
                                b.timeSlot.includes('6:') || b.timeSlot.includes('petang'));
                    });
                    
                    if (dayAfternoonBookings.length > 0) {
                        customCell.innerHTML = dayAfternoonBookings.map(booking => `
                            <div class="slot-booked slot-hover cursor-pointer mb-1 p-1 rounded text-xs" onclick="showBookingDetails(${JSON.stringify(booking).replace(/"/g, '&quot;')})">
                                <div class="font-semibold">${booking.timeSlot}</div>
                                <div>${booking.teacherName}</div>
                                <div>${booking.className}</div>
                            </div>
                        `).join('');
                    } else {
                        customCell.innerHTML = '<div class="text-xs text-gray-400">Tiada</div>';
                    }
                    
                    row.appendChild(customCell);
                }
                
                tableBody.appendChild(row);
            });

            // Update all 7 days count
            const countElements = ['monday-count', 'tuesday-count', 'wednesday-count', 'thursday-count', 'friday-count', 'saturday-count', 'sunday-count'];
            days.forEach((day, index) => {
                const dayCount = bookings.filter(b => b.day === day).length;
                document.getElementById(countElements[index]).textContent = dayCount;
            });
        }

        function refreshSchedule() {
            renderSchedule();
            showCloudNotification('ğŸ”„ Jadual dikemaskini');
        }

        function updateWeekDates() {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);
            
            const weekDatesElement = document.getElementById('week-dates');
            weekDatesElement.textContent = `Minggu: ${monday.toLocaleDateString('ms-MY')} - ${sunday.toLocaleDateString('ms-MY')}`;
        }

        function getDayDate(dayName) {
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            
            const dayIndex = days.indexOf(dayName);
            const dayDate = new Date(monday);
            
            // Adjust for Saturday (6) and Sunday (0)
            if (dayName === 'Sabtu') {
                dayDate.setDate(monday.getDate() + 5);
            } else if (dayName === 'Ahad') {
                dayDate.setDate(monday.getDate() + 6);
            } else {
                dayDate.setDate(monday.getDate() + dayIndex);
            }
            
            return dayDate.toLocaleDateString('ms-MY');
        }

        function showBookingDetails(booking) {
            const detailsDiv = document.getElementById('booking-details');
            detailsDiv.innerHTML = `
                <div><strong>ID:</strong> ${booking.id}</div>
                <div><strong>Guru:</strong> ${booking.teacherName}</div>
                <div><strong>Kelas:</strong> ${booking.className}</div>
                <div><strong>Hari:</strong> ${booking.day}</div>
                <div><strong>Masa:</strong> ${booking.timeSlot}</div>
                <div><strong>Tujuan:</strong> ${booking.purpose}</div>
                <div><strong>Email:</strong> ${booking.email || 'Tiada'}</div>
                <div><strong>Tarikh Tempah:</strong> ${booking.bookingDate}</div>
                ${booking.deviceId ? `<div><strong>Peranti:</strong> ${booking.deviceId.replace('device_', 'Device ')}</div>` : ''}
            `;
            document.getElementById('booking-modal').classList.remove('hidden');
            document.getElementById('booking-modal').classList.add('flex');
        }

        function closeBookingModal() {
            document.getElementById('booking-modal').classList.add('hidden');
            document.getElementById('booking-modal').classList.remove('flex');
        }

        // Admin Quick Booking Functions
        function showAdminQuickBooking() {
            if (!isAdminLoggedIn) {
                showErrorModal('Hanya pentadbir boleh menggunakan fungsi ini.');
                return;
            }
            
            document.getElementById('admin-booking-modal').classList.remove('hidden');
            document.getElementById('admin-booking-modal').classList.add('flex');
        }

        function closeAdminBookingModal() {
            document.getElementById('admin-booking-modal').classList.add('hidden');
            document.getElementById('admin-booking-modal').classList.remove('flex');
            document.getElementById('admin-booking-form').reset();
            document.getElementById('admin-custom-time-section').classList.add('hidden');
            document.getElementById('admin-availability-status').innerHTML = '';
        }

        function updateAdminTimeSlots() {
            const category = document.getElementById('admin-category').value;
            const timeSlotSelect = document.getElementById('admin-time-slot');
            
            timeSlotSelect.innerHTML = '<option value="">Pilih Masa</option>';
            
            if (category && timeSlots[category]) {
                timeSlots[category].forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot;
                    option.textContent = slot;
                    timeSlotSelect.appendChild(option);
                });
                
                const customOption = document.createElement('option');
                customOption.value = 'custom';
                customOption.textContent = 'Lain-lain masa (custom)';
                timeSlotSelect.appendChild(customOption);
            }
        }

        function checkAdminAvailability() {
            const day = document.getElementById('admin-day').value;
            const timeSlot = document.getElementById('admin-time-slot').value;
            const customTime = document.getElementById('admin-custom-time').value;
            const statusDiv = document.getElementById('admin-availability-status');

            if (timeSlot === 'custom') {
                document.getElementById('admin-custom-time-section').classList.remove('hidden');
            } else {
                document.getElementById('admin-custom-time-section').classList.add('hidden');
                document.getElementById('admin-custom-time').value = '';
            }

            if (day && timeSlot && timeSlot !== 'custom') {
                const existingBooking = bookings.find(b => b.day === day && b.timeSlot === timeSlot);
                if (existingBooking) {
                    statusDiv.innerHTML = `<span class="text-red-600 font-medium">âŒ Telah ditempah oleh ${existingBooking.teacherName} (${existingBooking.className})</span>`;
                } else {
                    statusDiv.innerHTML = `<span class="text-green-600 font-medium">âœ… Slot tersedia</span>`;
                }
            } else if (day && timeSlot === 'custom' && customTime) {
                const existingBooking = bookings.find(b => b.day === day && b.timeSlot === customTime);
                if (existingBooking) {
                    statusDiv.innerHTML = `<span class="text-red-600 font-medium">âŒ Telah ditempah oleh ${existingBooking.teacherName} (${existingBooking.className})</span>`;
                } else {
                    statusDiv.innerHTML = `<span class="text-green-600 font-medium">âœ… Slot tersedia</span>`;
                }
            } else {
                statusDiv.innerHTML = '';
            }
        }

        // Handle admin booking form submission
        document.getElementById('admin-booking-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            updateSyncStatus('syncing', 'Menyimpan...');
            
            const formData = new FormData(e.target);
            let timeSlot = formData.get('timeSlot');
            const customTime = formData.get('customTime');
            
            if (timeSlot === 'custom' && customTime) {
                timeSlot = customTime;
            } else if (timeSlot === 'custom' && !customTime) {
                showErrorModal('Sila masukkan masa custom.');
                updateSyncStatus('connected', 'ONLINE');
                return;
            }
            
            const booking = {
                id: nextId++,
                teacherName: formData.get('teacherName'),
                className: formData.get('className'),
                purpose: formData.get('purpose'),
                day: formData.get('day'),
                timeSlot: timeSlot,
                category: formData.get('category'),
                email: formData.get('email') || '',
                bookingDate: new Date().toLocaleDateString('ms-MY'),
                timestamp: new Date().toISOString(),
                deviceId: deviceId,
                addedBy: 'admin'
            };

            try {
                // Check if slot is already booked
                const existingBooking = bookings.find(b => 
                    b.day === booking.day && b.timeSlot === booking.timeSlot
                );

                if (existingBooking) {
                    showErrorModal(`Masa ${booking.timeSlot} pada hari ${booking.day} telah ditempah oleh ${existingBooking.teacherName} (${existingBooking.className}).`);
                    updateSyncStatus('connected', 'ONLINE');
                    return;
                }

                // Add booking
                bookings.push(booking);
                
                // Save to cloud and broadcast to all devices
                await saveToCloud('add_booking_admin', booking);

                // Send email notification (simulated)
                if (booking.email) {
                    simulateEmailNotification(booking);
                }

                showSuccessModal(`Tempahan berjaya ditambah oleh admin! Tempahan untuk ${booking.teacherName} - ${booking.day}, ${booking.timeSlot} telah disimpan.`);
                
                closeAdminBookingModal();
                
                refreshAllViews();
                
            } catch (error) {
                console.error('Failed to save admin booking:', error);
                showErrorModal('Gagal menyimpan tempahan. Cuba lagi.');
                updateSyncStatus('error', 'Ralat');
            }
        });

        // Listen for custom time input changes in admin form
        document.getElementById('admin-custom-time').addEventListener('input', function() {
            checkAdminAvailability();
        });

        // Admin login
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;

            if (username === 'admin' && password === 'adminict123') {
                isAdminLoggedIn = true;
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('bg-customizer').classList.remove('hidden');
                document.getElementById('admin-edit-home').classList.remove('hidden');
                
                // Update device as admin
                registerActiveDevice();
                
                renderAdminTable();
                updateCloudStatus();
                updateActiveDevicesList();
            } else {
                showErrorModal('Nama pengguna atau kata laluan salah!');
            }
        });

        function logoutAdmin() {
            isAdminLoggedIn = false;
            document.getElementById('admin-login').classList.remove('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-password').value = '';
            document.getElementById('bg-customizer').classList.add('hidden');
            document.getElementById('admin-edit-home').classList.add('hidden');
            
            // Update device as non-admin
            registerActiveDevice();
        }

        // Render admin table
        function renderAdminTable() {
            const tableBody = document.getElementById('admin-table');
            tableBody.innerHTML = '';

            if (bookings.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="9" class="border border-gray-300 px-4 py-8 text-center text-gray-500">Tiada tempahan dijumpai</td>';
                tableBody.appendChild(row);
                return;
            }

            bookings.forEach(booking => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-3">${booking.id}</td>
                    <td class="border border-gray-300 px-4 py-3">${booking.teacherName}</td>
                    <td class="border border-gray-300 px-4 py-3">${booking.className}</td>
                    <td class="border border-gray-300 px-4 py-3">${booking.day}</td>
                    <td class="border border-gray-300 px-4 py-3">${booking.timeSlot}</td>
                    <td class="border border-gray-300 px-4 py-3">${booking.purpose}</td>
                    <td class="border border-gray-300 px-4 py-3">${booking.email || 'Tiada'}</td>
                    <td class="border border-gray-300 px-4 py-3">${booking.bookingDate}</td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        <button onclick="deleteBooking(${booking.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition-colors">
                            Padam
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Delete booking with cloud sync
        async function deleteBooking(id) {
            try {
                updateSyncStatus('syncing', 'Memadam...');
                
                const bookingIndex = bookings.findIndex(b => b.id === id);
                if (bookingIndex > -1) {
                    const deletedBooking = bookings[bookingIndex];
                    bookings.splice(bookingIndex, 1);
                    
                    // Save to cloud
                    await saveToCloud('delete_booking', { id: id, booking: deletedBooking });
                    
                    refreshAllViews();
                    showCloudNotification(`ğŸ—‘ï¸ Tempahan ${deletedBooking.teacherName} dipadam`);
                }
                
            } catch (error) {
                console.error('Failed to delete booking:', error);
                updateSyncStatus('error', 'Gagal padam');
            }
        }

        // Clear all bookings with cloud sync
        async function clearAllBookings() {
            if (bookings.length === 0) {
                showErrorModal('Tiada tempahan untuk dipadam.');
                return;
            }
            
            // Create confirmation UI instead of using confirm()
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmModal.innerHTML = `
                <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center">
                    <div class="text-6xl mb-4">âš ï¿½ï¿½ï¿½</div>
                    <h3 class="text-xl font-bold text-red-800 mb-4">Pengesahan Diperlukan</h3>
                    <p class="text-gray-600 mb-6">Adakah anda pasti mahu memadam SEMUA tempahan? Tindakan ini tidak boleh dibatalkan.</p>
                    <div class="flex gap-4">
                        <button onclick="confirmClearAll()" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                            Ya, Padam Semua
                        </button>
                        <button onclick="cancelClearAll()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                            Batal
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            
            window.confirmClearAll = async function() {
                try {
                    updateSyncStatus('syncing', 'Memadam semua...');
                    
                    const deletedCount = bookings.length;
                    bookings = [];
                    nextId = 1;
                    
                    // Save to cloud
                    await saveToCloud('clear_all_bookings', { deletedCount: deletedCount });
                    
                    refreshAllViews();
                    showCloudNotification(`ğŸ—‘ï¸ Semua ${deletedCount} tempahan dipadam`);
                    
                } catch (error) {
                    console.error('Failed to clear all bookings:', error);
                    updateSyncStatus('error', 'Gagal padam semua');
                }
                
                document.body.removeChild(confirmModal);
            };
            
            window.cancelClearAll = function() {
                document.body.removeChild(confirmModal);
            };
        }

        // Export functions
        function exportData() {
            if (bookings.length === 0) {
                showErrorModal('Tiada data untuk dieksport.');
                return;
            }
            
            const csvContent = [
                ['ID', 'Nama Guru', 'Matapelajaran/Kelas', 'Hari', 'Masa', 'Tujuan', 'Email', 'Tarikh Tempah', 'Peranti'].join(','),
                ...bookings.map(booking => [
                    booking.id,
                    `"${booking.teacherName}"`,
                    `"${booking.className}"`,
                    booking.day,
                    `"${booking.timeSlot}"`,
                    `"${booking.purpose}"`,
                    booking.email || '',
                    booking.bookingDate,
                    booking.deviceId || ''
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `SMANIP_Tempahan_${new Date().toLocaleDateString('ms-MY').replace(/\//g, '-')}.csv`;
            link.click();
            
            showCloudNotification('ğŸ“Š Data CSV dieksport');
        }

        function exportPDF() {
            if (typeof jsPDF === 'undefined') {
                showErrorModal('PDF library tidak tersedia.');
                return;
            }
            
            if (bookings.length === 0) {
                showErrorModal('Tiada data untuk dieksport.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text('SMANIP - Laporan Tempahan Bilik', 20, 20);
            doc.text(`Tarikh: ${new Date().toLocaleDateString('ms-MY')}`, 20, 30);
            doc.text(`Jumlah Tempahan: ${bookings.length}`, 20, 40);
            
            let yPosition = 60;
            bookings.forEach((booking, index) => {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.text(`${index + 1}. ${booking.teacherName} - ${booking.className}`, 20, yPosition);
                doc.text(`   ${booking.day}, ${booking.timeSlot}`, 20, yPosition + 10);
                doc.text(`   ${booking.purpose}`, 20, yPosition + 20);
                yPosition += 35;
            });
            
            doc.save(`SMANIP_Laporan_${new Date().toLocaleDateString('ms-MY').replace(/\//g, '-')}.pdf`);
            showCloudNotification('ğŸ“„ Laporan PDF dieksport');
        }

        function saveSchedulePDF() {
            if (typeof jsPDF === 'undefined') {
                showErrorModal('PDF library tidak tersedia.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            doc.text('SMANIP - Jadual Tempahan Mingguan', 20, 20);
            doc.text(`Minggu: ${document.getElementById('week-dates').textContent.replace('Minggu: ', '')}`, 20, 30);
            
            // Create schedule table in PDF
            let yPos = 50;
            const timeSlots = ['7:00-8:00', '8:00-9:00', '9:00-10:00', '10:30-11:30', '11:30-12:30', '12:30-1:30'];
            
            // Header
            doc.text('Hari', 20, yPos);
            timeSlots.forEach((slot, index) => {
                doc.text(slot, 60 + (index * 35), yPos);
            });
            
            yPos += 15;
            
            // Days
            days.forEach(day => {
                doc.text(day, 20, yPos);
                timeSlots.forEach((slot, index) => {
                    const booking = bookings.find(b => b.day === day && b.timeSlot.includes(slot.split('-')[0]));
                    const text = booking ? `${booking.teacherName}\n${booking.className}` : 'KOSONG';
                    doc.text(text, 60 + (index * 35), yPos);
                });
                yPos += 20;
            });
            
            doc.save(`SMANIP_Jadual_${new Date().toLocaleDateString('ms-MY').replace(/\//g, '-')}.pdf`);
            showCloudNotification('ğŸ“¥ Jadual PDF dimuat turun');
        }

        function sendEmailNotifications() {
            const emailBookings = bookings.filter(b => b.email);
            if (emailBookings.length === 0) {
                showErrorModal('Tiada tempahan dengan alamat email.');
                return;
            }
            
            // Simulate sending emails
            emailBookings.forEach(booking => {
                simulateEmailNotification(booking);
            });
            
            showCloudNotification(`ğŸ“§ ${emailBookings.length} email notifikasi dihantar`);
        }

        // Modal functions
        function showSuccessModal(message) {
            document.getElementById('success-message').textContent = message;
            document.getElementById('success-modal').classList.remove('hidden');
            document.getElementById('success-modal').classList.add('flex');
        }

        function showErrorModal(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('success-modal').classList.add('hidden');
            document.getElementById('success-modal').classList.remove('flex');
            document.getElementById('error-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.remove('flex');
        }

        // Homepage editor functions
        function toggleHomeEditor() {
            const modal = document.getElementById('home-editor-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Load current values
            document.getElementById('edit-title').value = document.getElementById('homepage-title').textContent;
            document.getElementById('edit-description').value = document.getElementById('homepage-description').textContent;
        }

        function closeHomeEditor() {
            const modal = document.getElementById('home-editor-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        document.getElementById('home-editor-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = document.getElementById('edit-title').value;
            const description = document.getElementById('edit-description').value;
            
            document.getElementById('homepage-title').textContent = title;
            document.getElementById('homepage-description').textContent = description;
            
            // Save to localStorage and broadcast to all devices
            localStorage.setItem('smanip_homepage_title', title);
            localStorage.setItem('smanip_homepage_description', description);
            
            // Create broadcast event for cross-device sync
            const settingsEvent = {
                type: 'SETTINGS_SYNC',
                action: 'update_homepage',
                data: { title, description },
                deviceId: deviceId,
                timestamp: Date.now()
            };
            
            localStorage.setItem('smanip_cloud_settings_' + Date.now(), JSON.stringify(settingsEvent));
            
            closeHomeEditor();
            showCloudNotification('âœï¸ Homepage dikemaskini dan disync');
        });

        // Logo upload handler
        document.getElementById('logo-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) {
                    showErrorModal('Saiz fail terlalu besar. Maksimum 2MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const logoImg = document.getElementById('school-logo');
                    const defaultIcon = document.getElementById('default-icon');
                    
                    logoImg.src = e.target.result;
                    logoImg.classList.remove('hidden');
                    defaultIcon.classList.add('hidden');
                    
                    localStorage.setItem('smanip_school_logo', e.target.result);
                    
                    // Broadcast logo update to all devices
                    const logoEvent = {
                        type: 'SETTINGS_SYNC',
                        action: 'update_logo',
                        data: { logo: e.target.result },
                        deviceId: deviceId,
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem('smanip_cloud_logo_' + Date.now(), JSON.stringify(logoEvent));
                    showCloudNotification('ğŸ“· Logo dikemaskini dan disync');
                };
                reader.readAsDataURL(file);
            }
        });

        function removeLogo() {
            const logoImg = document.getElementById('school-logo');
            const defaultIcon = document.getElementById('default-icon');
            
            logoImg.src = '';
            logoImg.classList.add('hidden');
            defaultIcon.classList.remove('hidden');
            
            localStorage.removeItem('smanip_school_logo');
            document.getElementById('logo-upload').value = '';
            
            // Broadcast logo removal to all devices
            const logoEvent = {
                type: 'SETTINGS_SYNC',
                action: 'remove_logo',
                data: { logo: null },
                deviceId: deviceId,
                timestamp: Date.now()
            };
            
            localStorage.setItem('smanip_cloud_logo_' + Date.now(), JSON.stringify(logoEvent));
            showCloudNotification('ğŸ—‘ï¸ Logo dibuang dan disync');
        }

        // Background upload handler
        document.getElementById('bg-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showErrorModal('Saiz fail terlalu besar. Maksimum 5MB.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageUrl = e.target.result;
                    document.documentElement.style.setProperty('--custom-bg', `url(${imageUrl})`);
                    localStorage.setItem('smanip_custom_bg', imageUrl);
                    
                    // Broadcast background update to all devices
                    const bgEvent = {
                        type: 'SETTINGS_SYNC',
                        action: 'update_background',
                        data: { background: imageUrl },
                        deviceId: deviceId,
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem('smanip_cloud_bg_' + Date.now(), JSON.stringify(bgEvent));
                    showCloudNotification('ğŸ–¼ï¸ Latar belakang dikemaskini dan disync');
                };
                reader.readAsDataURL(file);
            }
        });

        function removeCustomBg() {
            document.documentElement.style.setProperty('--custom-bg', 'linear-gradient(135deg, #f0fdf4, #dcfce7)');
            localStorage.removeItem('smanip_custom_bg');
            localStorage.removeItem('smanip_bg');
            document.getElementById('bg-upload').value = '';
            
            // Broadcast background removal to all devices
            const bgEvent = {
                type: 'SETTINGS_SYNC',
                action: 'remove_background',
                data: { background: 'linear-gradient(135deg, #f0fdf4, #dcfce7)' },
                deviceId: deviceId,
                timestamp: Date.now()
            };
            
            localStorage.setItem('smanip_cloud_bg_' + Date.now(), JSON.stringify(bgEvent));
            showCloudNotification('ğŸ—‘ï¸ Latar belakang direset dan disync');
        }

        function setHomeBg(gradient) {
            document.documentElement.style.setProperty('--custom-bg', gradient);
            localStorage.setItem('smanip_bg', gradient);
            
            // Broadcast background update to all devices
            const bgEvent = {
                type: 'SETTINGS_SYNC',
                action: 'update_background',
                data: { background: gradient },
                deviceId: deviceId,
                timestamp: Date.now()
            };
            
            localStorage.setItem('smanip_cloud_bg_' + Date.now(), JSON.stringify(bgEvent));
            showCloudNotification('ğŸ¨ Tema dikemaskini dan disync');
        }

        function setIslamicPattern(pattern) {
            // Islamic pattern implementations would go here
            showCloudNotification(`ğŸ¨ Corak ${pattern} dipilih`);
        }

        function showUsageDetails() {
            const totalSlots = 7 * 6; // 7 days * 6 time slots
            const usedSlots = bookings.length;
            const usageRate = totalSlots > 0 ? Math.round((usedSlots / totalSlots) * 100) : 0;
            
            showSuccessModal(`Statistik Penggunaan:\n\nJumlah Slot: ${totalSlots}\nSlot Digunakan: ${usedSlots}\nSlot Tersedia: ${totalSlots - usedSlots}\nKadar Penggunaan: ${usageRate}%`);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Load booking status
            const savedBookingStatus = localStorage.getItem('smanip_booking_open');
            if (savedBookingStatus !== null) {
                isBookingOpen = savedBookingStatus === 'true';
            }
            
            // Load saved settings
            const savedBg = localStorage.getItem('smanip_bg') || localStorage.getItem('smanip_custom_bg');
            if (savedBg) {
                if (savedBg.startsWith('data:')) {
                    document.documentElement.style.setProperty('--custom-bg', `url(${savedBg})`);
                } else {
                    document.documentElement.style.setProperty('--custom-bg', savedBg);
                }
            }
            
            const savedTitle = localStorage.getItem('smanip_homepage_title');
            const savedDescription = localStorage.getItem('smanip_homepage_description');
            const savedLogo = localStorage.getItem('smanip_school_logo');
            
            if (savedTitle) {
                document.getElementById('homepage-title').textContent = savedTitle;
            }
            if (savedDescription) {
                document.getElementById('homepage-description').textContent = savedDescription;
            }
            if (savedLogo) {
                const logoImg = document.getElementById('school-logo');
                const defaultIcon = document.getElementById('default-icon');
                logoImg.src = savedLogo;
                logoImg.classList.remove('hidden');
                defaultIcon.classList.add('hidden');
            }
            
            // Initialize cloud database
            initializeCloudDatabase();
            
            // Initial UI update
            updateStats();
            renderSchedule();
            updateUserCount();
            updateBookingStatusUI();
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a71433e204624d2',t:'MTc2NDU3ODI0Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
